<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<link href="coqdocjs.css" rel="stylesheet" type="text/css"/>
<link href="toc.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="coqdocjs.js"></script>
</head>

<body onload="document.getElementById('content').focus()">
  <div id="header">
    <span class="left">
      <span class="modulename"> <script> document.write(document.title) </script> </span>
      <span id="toggle-toc">Contents</span>
    </span>

    <span class="button" id="toggle-proofs"></span>

    <span class="right">
      <a href="https://github.com/AU-COBRA/ConCert" target="_balnk">Project Page</a>
      <a href="index.html">Index</a>
      <a href="toc.html">Table of contents</a>
    </span>
</div>
  <div id="content" tabindex="-1" onblur="document.getElementById('content').focus()">
    <div id="js-toc" class="toc" data-toc="h1,h2,h3,h4" data-toc-container="doc" data-toc-offset="-40">
      <div id="js-toc-header" class="toc-header">Contents:</div>
    </div>
    <div id="main">
<h1 class="libtitle">Library ConCert.Examples.Dexter.DexterTests</h1>

<div class="code">

<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Utils.Extras.html#"><span class="id" title="library">Extras</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Blockchain.html#"><span class="id" title="library">Blockchain</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Serializable.html#"><span class="id" title="library">Serializable</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Containers.html#"><span class="id" title="library">Containers</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.ResultMonad.html#"><span class="id" title="library">ResultMonad</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Monad.html#"><span class="id" title="library">Monad</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution.Test</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Test.QCTest.html#"><span class="id" title="library">QCTest</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.Dexter</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.Dexter.Dexter.html#"><span class="id" title="library">Dexter</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.Dexter</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Export</span> <a class="idref" href="ConCert.Examples.Dexter.DexterPrinters.html#"><span class="id" title="library">DexterPrinters</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.Dexter</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.Dexter.DexterGens.html#"><span class="id" title="library">DexterGens</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.EIP20</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#"><span class="id" title="library">EIP20Token</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.ZArith_base.html#"><span class="id" title="library">ZArith_base</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#"><span class="id" title="library">List</span></a>. <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ListNotations"><span class="id" title="module">ListNotations</span></a>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="token_pool_size" class="idref" href="#token_pool_size"><span class="id" title="definition">token_pool_size</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Numbers.BinNums.html#N"><span class="id" title="inductive">N</span></a> := 100.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="token_setup" class="idref" href="#token_setup"><span class="id" title="definition">token_setup</span></a> : <a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#Setup"><span class="id" title="record">EIP20Token.Setup</span></a> := {|<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#owner"><span class="id" title="projection">EIP20Token.owner</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#init_amount"><span class="id" title="projection">EIP20Token.init_amount</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_pool_size"><span class="id" title="definition">token_pool_size</span></a>;<br/>
|}.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="token_caddr" class="idref" href="#token_caddr"><span class="id" title="definition">token_caddr</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#addr_of_Z"><span class="id" title="definition">addr_of_Z</span></a> 128.<br/>
<span class="id" title="keyword">Definition</span> <a id="dexter_caddr" class="idref" href="#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#addr_of_Z"><span class="id" title="definition">addr_of_Z</span></a> 129.<br/>

<br/>
<span class="comment">(*&nbsp;Dexter&nbsp;will&nbsp;have&nbsp;60&nbsp;tokens&nbsp;in&nbsp;reverse&nbsp;initially&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="dexter_setup" class="idref" href="#dexter_setup"><span class="id" title="definition">dexter_setup</span></a> : <a class="idref" href="ConCert.Examples.Dexter.Dexter.html#Setup"><span class="id" title="record">Dexter.Setup</span></a> := {|<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.Dexter.Dexter.html#token_caddr_"><span class="id" title="projection">token_caddr_</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_caddr"><span class="id" title="definition">token_caddr</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.Dexter.Dexter.html#token_pool_"><span class="id" title="projection">token_pool_</span></a> := (<a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_pool_size"><span class="id" title="definition">token_pool_size</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">-</span></a> 40);<br/>
|}.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="add_as_operator_act" class="idref" href="#add_as_operator_act"><span class="id" title="definition">add_as_operator_act</span></a> <a id="owner:1" class="idref" href="#owner:1"><span class="id" title="binder">owner</span></a> <a id="operator:2" class="idref" href="#operator:2"><span class="id" title="binder">operator</span></a> <a id="tokens:3" class="idref" href="#tokens:3"><span class="id" title="binder">tokens</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_call"><span class="id" title="definition">build_call</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#owner:1"><span class="id" title="variable">owner</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_caddr"><span class="id" title="definition">token_caddr</span></a> 0 (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#approve"><span class="id" title="constructor">EIP20Token.approve</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#operator:2"><span class="id" title="variable">operator</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#tokens:3"><span class="id" title="variable">tokens</span></a>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="exchange_tokens_to_money_act" class="idref" href="#exchange_tokens_to_money_act"><span class="id" title="definition">exchange_tokens_to_money_act</span></a> <a id="owner:4" class="idref" href="#owner:4"><span class="id" title="binder">owner</span></a> <a id="amount:5" class="idref" href="#amount:5"><span class="id" title="binder">amount</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_call"><span class="id" title="definition">build_call</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#owner:4"><span class="id" title="variable">owner</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a> 0 (<a class="idref" href="ConCert.Examples.Dexter.Dexter.html#tokens_to_asset"><span class="id" title="constructor">Dexter.tokens_to_asset</span></a> {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.Dexter.Dexter.html#exchange_owner"><span class="id" title="projection">exchange_owner</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#owner:4"><span class="id" title="variable">owner</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.Dexter.Dexter.html#tokens_sold"><span class="id" title="projection">tokens_sold</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#amount:5"><span class="id" title="variable">amount</span></a>;<br/>
&nbsp;&nbsp;|}).<br/>

<br/>
<span class="comment">(*&nbsp;Setup&nbsp;a&nbsp;chain&nbsp;with&nbsp;token&nbsp;contract,&nbsp;and&nbsp;dexter&nbsp;contract&nbsp;deployed.<br/>
&nbsp;&nbsp;&nbsp;Also&nbsp;adds&nbsp;some&nbsp;tokens&nbsp;to&nbsp;person_1&nbsp;and&nbsp;dexter&nbsp;contract,&nbsp;and&nbsp;adds&nbsp;some&nbsp;operators&nbsp;on&nbsp;the&nbsp;fa2&nbsp;contract&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="chain" class="idref" href="#chain"><span class="id" title="definition">chain</span></a> : <a class="idref" href="ConCert.Execution.Test.TestUtils.html#ChainBuilder"><span class="id" title="instance">ChainBuilder</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#unpack_result"><span class="id" title="definition">unpack_result</span></a> (<a class="idref" href="ConCert.Execution.Test.TraceGens.html#add_block"><span class="id" title="definition">TraceGens.add_block</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#builder_initial"><span class="id" title="method">builder_initial</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a> <span class="comment">(*&nbsp;Give&nbsp;10&nbsp;to&nbsp;person&nbsp;1&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> 10 <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Deploy&nbsp;contracts&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_deploy"><span class="id" title="definition">build_deploy</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> 0 <a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#contract"><span class="id" title="definition">EIP20Token.contract</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_setup"><span class="id" title="definition">token_setup</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_deploy"><span class="id" title="definition">build_deploy</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> 30 <a class="idref" href="ConCert.Examples.Dexter.Dexter.html#contract"><span class="id" title="definition">Dexter.contract</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_setup"><span class="id" title="definition">dexter_setup</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Tranfer&nbsp;tokens&nbsp;to&nbsp;exchange&nbsp;contract&nbsp;and&nbsp;person1&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_call"><span class="id" title="definition">build_call</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_caddr"><span class="id" title="definition">token_caddr</span></a> 0 (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#transfer"><span class="id" title="constructor">EIP20Token.transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> 40%<span class="id" title="var">N</span>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_call"><span class="id" title="definition">build_call</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_caddr"><span class="id" title="definition">token_caddr</span></a> 0 (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#transfer"><span class="id" title="constructor">EIP20Token.transfer</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a> (<a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_pool_size"><span class="id" title="definition">token_pool_size</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">-</span></a> 40)%<span class="id" title="var">N</span>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Let&nbsp;dexter&nbsp;transfer&nbsp;tokens&nbsp;on&nbsp;behalf&nbsp;of&nbsp;person_1&nbsp;and&nbsp;person_2&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#add_as_operator_act"><span class="id" title="definition">add_as_operator_act</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_pool_size"><span class="id" title="definition">token_pool_size</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#add_as_operator_act"><span class="id" title="definition">add_as_operator_act</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_2"><span class="id" title="definition">person_2</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_pool_size"><span class="id" title="definition">token_pool_size</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="add_block_with_acts" class="idref" href="#add_block_with_acts"><span class="id" title="definition">add_block_with_acts</span></a> (<a id="c:6" class="idref" href="#c:6"><span class="id" title="binder">c</span></a> : <a class="idref" href="ConCert.Execution.Test.TestUtils.html#ChainBuilder"><span class="id" title="instance">ChainBuilder</span></a>) <a id="acts:7" class="idref" href="#acts:7"><span class="id" title="binder">acts</span></a> :=<br/>
&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Test.TraceGens.html#add_block"><span class="id" title="definition">TraceGens.add_block</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#c:6"><span class="id" title="variable">c</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#acts:7"><span class="id" title="variable">acts</span></a>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="dexter_state" class="idref" href="#dexter_state"><span class="id" title="definition">dexter_state</span></a> <a id="env:8" class="idref" href="#env:8"><span class="id" title="binder">env</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.Dexter.Dexter.html#State"><span class="id" title="record">Dexter.State</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#env:8"><span class="id" title="variable">env</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a>.<br/>
<span class="id" title="keyword">Definition</span> <a id="token_state" class="idref" href="#token_state"><span class="id" title="definition">token_state</span></a> <a id="env:9" class="idref" href="#env:9"><span class="id" title="binder">env</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#State"><span class="id" title="record">EIP20Token.State</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#env:9"><span class="id" title="variable">env</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_caddr"><span class="id" title="definition">token_caddr</span></a>.<br/>

<br/>
<span class="id" title="keyword">Module</span> <a id="TestInfo" class="idref" href="#TestInfo"><span class="id" title="module">TestInfo</span></a> &lt;: <a class="idref" href="ConCert.Examples.Dexter.DexterGens.html#DexterTestsInfo"><span class="id" title="module">DexterTestsInfo</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.token_caddr" class="idref" href="#TestInfo.token_caddr"><span class="id" title="definition">token_caddr</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_caddr"><span class="id" title="definition">token_caddr</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.dexter_contract_addr" class="idref" href="#TestInfo.dexter_contract_addr"><span class="id" title="definition">dexter_contract_addr</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.test_accounts" class="idref" href="#TestInfo.test_accounts"><span class="id" title="definition">test_accounts</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a>.<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#TestInfo"><span class="id" title="module">TestInfo</span></a>.<br/>
<span class="id" title="keyword">Module</span> <a id="MG" class="idref" href="#MG"><span class="id" title="module">MG</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterGens.html#DexterGens"><span class="id" title="module">DexterGens.DexterGens</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#TestInfo"><span class="id" title="module">TestInfo</span></a>. <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#MG"><span class="id" title="module">MG</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;Sample&nbsp;(gDexterAction&nbsp;chain1).&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Sample&nbsp;((liftM&nbsp;(fun&nbsp;a&nbsp;=&gt;&nbsp;add_block_with_acts&nbsp;chain1&nbsp;<span class="inlinecode"><span class="id" title="var">a</span></span>)&nbsp;(gDexterAction&nbsp;chain1))).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Sample&nbsp;(gDexterChain&nbsp;2&nbsp;chain1&nbsp;1).&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="person_1_initial_balance" class="idref" href="#person_1_initial_balance"><span class="id" title="definition">person_1_initial_balance</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Amount"><span class="id" title="definition">Amount</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#chain"><span class="id" title="definition">chain</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="dexter_liquidity" class="idref" href="#dexter_liquidity"><span class="id" title="definition">dexter_liquidity</span></a> <a id="chain:10" class="idref" href="#chain:10"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Amount"><span class="id" title="definition">Amount</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#chain:10"><span class="id" title="variable">chain</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="account_tokens" class="idref" href="#account_tokens"><span class="id" title="definition">account_tokens</span></a> (<a id="env:11" class="idref" href="#env:11"><span class="id" title="binder">env</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Environment"><span class="id" title="record">Environment</span></a>) (<a id="account:12" class="idref" href="#account:12"><span class="id" title="binder">account</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a>) : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Numbers.BinNums.html#N"><span class="id" title="inductive">N</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0%<span class="id" title="var">N</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <a id="token_state:13" class="idref" href="#token_state:13"><span class="id" title="binder">token_state</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_state"><span class="id" title="definition">token_state</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#env:11"><span class="id" title="variable">env</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#account:12"><span class="id" title="variable">account</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#token_state:13"><span class="id" title="variable">token_state</span></a>.(<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#balances"><span class="id" title="projection">EIP20Token.balances</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="dexter_token_pool" class="idref" href="#dexter_token_pool"><span class="id" title="definition">dexter_token_pool</span></a> (<a id="env:14" class="idref" href="#env:14"><span class="id" title="binder">env</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Environment"><span class="id" title="record">Environment</span></a>) : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Numbers.BinNums.html#N"><span class="id" title="inductive">N</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0%<span class="id" title="var">N</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <a id="s:15" class="idref" href="#s:15"><span class="id" title="binder">s</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_state"><span class="id" title="definition">dexter_state</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#env:14"><span class="id" title="variable">env</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#s:15"><span class="id" title="variable">s</span></a>.(<a class="idref" href="ConCert.Examples.Dexter.Dexter.html#token_pool"><span class="id" title="projection">token_pool</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;).<br/>

<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">Z_scope</span>.<br/>
<span class="id" title="keyword">Coercion</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">Z.of_N</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">:</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">N</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">&gt;-&gt;</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">Z</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;Asserts&nbsp;that&nbsp;exchanges&nbsp;are&nbsp;priced&nbsp;correctly&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="tokens_to_asset_correct_P_opt" class="idref" href="#tokens_to_asset_correct_P_opt"><span class="id" title="definition">tokens_to_asset_correct_P_opt</span></a> (<a id="old_env:16" class="idref" href="#old_env:16"><span class="id" title="binder">old_env</span></a> <a id="new_env:17" class="idref" href="#new_env:17"><span class="id" title="binder">new_env</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Environment"><span class="id" title="record">Environment</span></a>) : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <span class="id" title="definition">Checker</span> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <a id="state_dexter:18" class="idref" href="#state_dexter:18"><span class="id" title="binder">state_dexter</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_state"><span class="id" title="definition">dexter_state</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#new_env:17"><span class="id" title="variable">new_env</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="person_1_balance:19" class="idref" href="#person_1_balance:19"><span class="id" title="binder">person_1_balance</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#new_env:17"><span class="id" title="variable">new_env</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="dexter_balance:20" class="idref" href="#dexter_balance:20"><span class="id" title="binder">dexter_balance</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#new_env:17"><span class="id" title="variable">new_env</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="dexter_initial_balance:21" class="idref" href="#dexter_initial_balance:21"><span class="id" title="binder">dexter_initial_balance</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#old_env:16"><span class="id" title="variable">old_env</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="dexter_initial_token_reserve:22" class="idref" href="#dexter_initial_token_reserve:22"><span class="id" title="binder">dexter_initial_token_reserve</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#account_tokens"><span class="id" title="definition">account_tokens</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#old_env:16"><span class="id" title="variable">old_env</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="dexter_current_token_reserve:23" class="idref" href="#dexter_current_token_reserve:23"><span class="id" title="binder">dexter_current_token_reserve</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#account_tokens"><span class="id" title="definition">account_tokens</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#new_env:17"><span class="id" title="variable">new_env</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_caddr"><span class="id" title="definition">dexter_caddr</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;assume&nbsp;only&nbsp;the&nbsp;given&nbsp;account&nbsp;has&nbsp;made&nbsp;exchanges&nbsp;in&nbsp;this&nbsp;time&nbsp;period.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;assumption&nbsp;holds&nbsp;for&nbsp;these&nbsp;tests.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="tokens_received:24" class="idref" href="#tokens_received:24"><span class="id" title="binder">tokens_received</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_current_token_reserve:23"><span class="id" title="variable">dexter_current_token_reserve</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#::Z_scope:x_'-'_x"><span class="id" title="notation">-</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_initial_token_reserve:22"><span class="id" title="variable">dexter_initial_token_reserve</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Calculate&nbsp;token&nbsp;exchange&nbsp;price&nbsp;if&nbsp;only&nbsp;a&nbsp;single&nbsp;exchange&nbsp;was&nbsp;made&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="expected_currency_sold:25" class="idref" href="#expected_currency_sold:25"><span class="id" title="binder">expected_currency_sold</span></a> := <a class="idref" href="ConCert.Examples.Dexter.Dexter.html#getInputPrice"><span class="id" title="definition">getInputPrice</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#tokens_received:24"><span class="id" title="variable">tokens_received</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_initial_token_reserve:22"><span class="id" title="variable">dexter_initial_token_reserve</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_initial_balance:21"><span class="id" title="variable">dexter_initial_balance</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="expected_dexter_balance:26" class="idref" href="#expected_dexter_balance:26"><span class="id" title="binder">expected_dexter_balance</span></a> := <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_initial_balance:21"><span class="id" title="variable">dexter_initial_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#::Z_scope:x_'-'_x"><span class="id" title="notation">-</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#expected_currency_sold:25"><span class="id" title="variable">expected_currency_sold</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"dexter balance was " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_balance:20"><span class="id" title="variable">dexter_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" while it was expected to be at least " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#expected_dexter_balance:26"><span class="id" title="variable">expected_dexter_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"person_1 balance: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#person_1_balance:19"><span class="id" title="variable">person_1_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"person_1 tokens: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> (<a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#account_tokens"><span class="id" title="definition">account_tokens</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#new_env:17"><span class="id" title="variable">new_env</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"dexter balance: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_balance:20"><span class="id" title="variable">dexter_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"dexter tokens: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_current_token_reserve:23"><span class="id" title="variable">dexter_current_token_reserve</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"history: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> (<a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#state_dexter:18"><span class="id" title="variable">state_dexter</span></a>.(<a class="idref" href="ConCert.Examples.Dexter.Dexter.html#price_history"><span class="id" title="projection">price_history</span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#expected_dexter_balance:26"><span class="id" title="variable">expected_dexter_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#90a0b0fc12252358f48538aa18bc4b8e"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#dexter_balance:20"><span class="id" title="variable">dexter_balance</span></a>))<br/>
&nbsp;&nbsp;).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="tokens_to_asset_correct_P" class="idref" href="#tokens_to_asset_correct_P"><span class="id" title="definition">tokens_to_asset_correct_P</span></a> <a id="old_env:27" class="idref" href="#old_env:27"><span class="id" title="binder">old_env</span></a> <a id="env:28" class="idref" href="#env:28"><span class="id" title="binder">env</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#tokens_to_asset_correct_P_opt"><span class="id" title="definition">tokens_to_asset_correct_P_opt</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#old_env:27"><span class="id" title="variable">old_env</span></a> <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#env:28"><span class="id" title="variable">env</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">p</span> =&gt; <span class="id" title="var">p</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="tokens_to_asset_correct" class="idref" href="#tokens_to_asset_correct"><span class="id" title="definition">tokens_to_asset_correct</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TraceGens.html#forAllChainStatePairs"><span class="id" title="definition">forAllChainStatePairs</span></a> 1 <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#chain"><span class="id" title="definition">chain</span></a> (<a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#gDexterChain"><span class="id" title="definition">gDexterChain</span></a> 2) <a class="idref" href="ConCert.Examples.Dexter.DexterTests.html#tokens_to_asset_correct_P"><span class="id" title="definition">tokens_to_asset_correct_P</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;We&nbsp;first&nbsp;test&nbsp;the&nbsp;Dexter&nbsp;contract&nbsp;with&nbsp;breadth-first&nbsp;execution&nbsp;model&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(tokens_to_asset_correct).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;We&nbsp;see&nbsp;that&nbsp;the&nbsp;property&nbsp;holds&nbsp;with&nbsp;breadt-first&nbsp;execution&nbsp;model&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;However,&nbsp;the&nbsp;Dexter&nbsp;contract&nbsp;was&nbsp;designed&nbsp;for&nbsp;Tezos&nbsp;which&nbsp;used<br/>
&nbsp;&nbsp;&nbsp;breadth-first&nbsp;execution&nbsp;model.<br/>
&nbsp;&nbsp;&nbsp;Thus&nbsp;we&nbsp;next&nbsp;test&nbsp;the&nbsp;property&nbsp;with&nbsp;that&nbsp;model&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Extract&nbsp;Constant&nbsp;DepthFirst&nbsp;=&gt;&nbsp;"false".<br/>
QuickChick&nbsp;(tokens_to_asset_correct).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
Chain{|<br/>
Block&nbsp;1&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_deploy</span></span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">DexterSetup</span>{<span class="id" title="var">token_caddr_</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">token_pool_</span>:</span> <span class="inlinecode">100})};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_deploy</span></span> <span class="inlinecode">30,</span> <span class="inlinecode"><span class="id" title="var">DexterSetup</span>{<span class="id" title="var">token_caddr_</span>:</span> <span class="inlinecode">128%256,</span> <span class="inlinecode"><span class="id" title="var">token_pool_</span>:</span> <span class="inlinecode">60})};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">DexterSetup</span>{<span class="id" title="var">token_caddr_</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">token_pool_</span>:</span> <span class="inlinecode">40})};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">DexterSetup</span>{<span class="id" title="var">token_caddr_</span>:</span> <span class="inlinecode">129%256,</span> <span class="inlinecode"><span class="id" title="var">token_pool_</span>:</span> <span class="inlinecode">60})};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">approve</span></span> <span class="inlinecode">129%256</span> <span class="inlinecode">100)}</span>;<br/>
Block&nbsp;2&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">129%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">token_to_asset</span></span> <span class="inlinecode"><span class="id" title="var">exchange</span>{<span class="id" title="var">exchange_owner</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">tokens_sold</span>:</span> <span class="inlinecode">20})};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">129%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">token_to_asset</span></span> <span class="inlinecode"><span class="id" title="var">exchange</span>{<span class="id" title="var">exchange_owner</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">tokens_sold</span>:</span> <span class="inlinecode">14})}</span>;&nbsp;|}<br/>
<br/>
dexter&nbsp;balance&nbsp;was&nbsp;19&nbsp;while&nbsp;it&nbsp;was&nbsp;expected&nbsp;to&nbsp;be&nbsp;at&nbsp;least&nbsp;20<br/>
person_1&nbsp;balance:&nbsp;11<br/>
person_1&nbsp;tokens:&nbsp;6<br/>
dexter&nbsp;balance:&nbsp;19<br/>
dexter&nbsp;tokens:&nbsp;94<br/>
history:&nbsp;<span class="inlinecode">7;</span> <span class="inlinecode">4</span><br/>
***&nbsp;Failed&nbsp;after&nbsp;23&nbsp;tests&nbsp;and&nbsp;2&nbsp;shrinks.&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="comment">(*&nbsp;We&nbsp;can&nbsp;see&nbsp;that&nbsp;the&nbsp;property&nbsp;fails&nbsp;in&nbsp;breadth-first&nbsp;model&nbsp;when&nbsp;two&nbsp;trades&nbsp;are&nbsp;made<br/>
&nbsp;&nbsp;&nbsp;in&nbsp;the&nbsp;same&nbsp;block.&nbsp;Below&nbsp;we&nbsp;simulate&nbsp;what&nbsp;goes&nbsp;wrong&nbsp;in&nbsp;this&nbsp;example.<br/>
&nbsp;&nbsp;&nbsp;The&nbsp;starting&nbsp;configuration&nbsp;is<br/>
&nbsp;&nbsp;&nbsp;person_1&nbsp;balance:&nbsp;10<br/>
&nbsp;&nbsp;&nbsp;person_1&nbsp;tokens:&nbsp;40<br/>
&nbsp;&nbsp;&nbsp;dexter&nbsp;balance:&nbsp;30<br/>
&nbsp;&nbsp;&nbsp;dexter&nbsp;tokens:&nbsp;60<br/>
*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(env_account_balances&nbsp;chain&nbsp;person_1).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;=&nbsp;10&nbsp;:&nbsp;N&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(account_tokens&nbsp;chain&nbsp;person_1).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;=&nbsp;40&nbsp;:&nbsp;N&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(env_account_balances&nbsp;chain&nbsp;dexter_caddr).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;=&nbsp;30&nbsp;:&nbsp;N&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(account_tokens&nbsp;chain&nbsp;dexter_caddr).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;=&nbsp;60&nbsp;:&nbsp;N&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;If&nbsp;both&nbsp;trades&nbsp;were&nbsp;merged&nbsp;person_1&nbsp;would&nbsp;get&nbsp;10&nbsp;tez&nbsp;for&nbsp;his&nbsp;34&nbsp;tokens&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;34&nbsp;60&nbsp;30).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;=&nbsp;10&nbsp;:&nbsp;Z&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;However,&nbsp;this&nbsp;is&nbsp;not&nbsp;what&nbsp;happens,&nbsp;in&nbsp;total&nbsp;person_1&nbsp;gains&nbsp;7+4=11&nbsp;tez&nbsp;from<br/>
&nbsp;&nbsp;&nbsp;trading&nbsp;34&nbsp;tokens&nbsp;(20&nbsp;in&nbsp;the&nbsp;first&nbsp;trade,&nbsp;14&nbsp;in&nbsp;the&nbsp;second)&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;In&nbsp;the&nbsp;first&nbsp;trade&nbsp;person_1&nbsp;trades&nbsp;20&nbsp;tokens&nbsp;for&nbsp;7&nbsp;tez&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;20&nbsp;60&nbsp;30).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;=&nbsp;7&nbsp;:&nbsp;Z&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;In&nbsp;the&nbsp;second&nbsp;trade&nbsp;we&nbsp;would&nbsp;expect&nbsp;person_1&nbsp;to&nbsp;get&nbsp;3&nbsp;tez&nbsp;for&nbsp;his&nbsp;14&nbsp;tokens&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;14&nbsp;80&nbsp;23).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;=&nbsp;3&nbsp;:&nbsp;Z&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;However,&nbsp;this&nbsp;is&nbsp;not&nbsp;the&nbsp;calculation&nbsp;that&nbsp;is&nbsp;being&nbsp;done.<br/>
&nbsp;&nbsp;&nbsp;Instead&nbsp;the&nbsp;contract&nbsp;computes&nbsp;the&nbsp;yield&nbsp;of&nbsp;the&nbsp;second&nbsp;trade&nbsp;as&nbsp;follows&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;14&nbsp;80&nbsp;30).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;=&nbsp;4&nbsp;:&nbsp;Z&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;This&nbsp;is&nbsp;because&nbsp;in&nbsp;breadth&nbsp;first&nbsp;execution&nbsp;model&nbsp;both&nbsp;trades&nbsp;gets&nbsp;started&nbsp;before&nbsp;tokens&nbsp;and&nbsp;tez<br/>
&nbsp;&nbsp;&nbsp;from&nbsp;previous&nbsp;trades&nbsp;have&nbsp;been&nbsp;transferred.&nbsp;Thus&nbsp;trades&nbsp;uses&nbsp;wrong&nbsp;values.<br/>
&nbsp;&nbsp;&nbsp;Dexter&nbsp;manually&nbsp;tracks&nbsp;and&nbsp;decrements&nbsp;the&nbsp;number&nbsp;of&nbsp;tokens&nbsp;in&nbsp;the&nbsp;reserve&nbsp;because&nbsp;of&nbsp;this.<br/>
&nbsp;&nbsp;&nbsp;However,&nbsp;the&nbsp;contract&nbsp;doesn't&nbsp;manually&nbsp;track&nbsp;tez&nbsp;the&nbsp;same&nbsp;way,&nbsp;thus&nbsp;the&nbsp;tez&nbsp;amount&nbsp;used&nbsp;is&nbsp;wrong.&nbsp;*)</span><br/>
</div>
</div>
<div id="footer">
  Generated by <a href="https://coq.inria.fr/">coqdoc</a> and improved with <a href="https://github.com/tebbi/coqdocjs">CoqdocJS</a> and <a href="https://github.com/jgallen23/toc">TOC</a>
</div>
</div>
<script>
  const elements = document.getElementsByClassName("libtitle");
  while(elements.length > 0){
        elements[0].parentNode.removeChild(elements[0]);
  }
  if (window.location.pathname.endsWith("/toc.html")) {
      const jstocDiv = document.getElementById("js-toc");
      jstocDiv.classList.remove("toc");
      jstocDiv.classList.add("jstoc-hidden");
      const jstocHeaderDiv = document.getElementById("js-toc-header");
      jstocHeaderDiv.classList.add("jstoc-hidden");
      const mainDiv = document.getElementById("main");
      mainDiv.classList.add("jstoc-hidden-main");
      const toggleDiv = document.getElementById("toggle-toc");
      toggleDiv.classList.add("jstoc-hidden");
  }
  console.log(window.location.pathname);
</script>
<script type="text/javascript" src="toc.js"></script>
</body>

</html>
