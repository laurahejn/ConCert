<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<link href="coqdocjs.css" rel="stylesheet" type="text/css"/>
<link href="toc.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="coqdocjs.js"></script>
</head>

<body onload="document.getElementById('content').focus()">
  <div id="header">
    <span class="left">
      <span class="modulename"> <script> document.write(document.title) </script> </span>
      <span id="toggle-toc">Contents</span>
    </span>

    <span class="button" id="toggle-proofs"></span>

    <span class="right">
      <a href="https://github.com/AU-COBRA/ConCert" target="_balnk">Project Page</a>
      <a href="index.html">Index</a>
      <a href="toc.html">Table of contents</a>
    </span>
</div>
  <div id="content" tabindex="-1" onblur="document.getElementById('content').focus()">
    <div id="js-toc" class="toc" data-toc="h1,h2,h3,h4" data-toc-container="doc" data-toc-offset="-40">
      <div id="js-toc-header" class="toc-header">Contents:</div>
    </div>
    <div id="main">
<h1 class="libtitle">Library ConCert.Examples.BAT.BATFixed</h1>

<div class="code">
</div>

<div class="doc">
<a id="lab168"></a><h1 class="section">Basic Attention Token contract</h1>
 This implementation of the Basic Attention Token is a based on
    https://github.com/brave-intl/basic-attention-token-crowdsale/blob/66c886cc4bfb0493d9e7980f392ca7921ef1e7fc/contracts/BAToken.sol
    The implementation includes some minor changes that fixes bugs present in the original Solidity implementation.

<div class="paragraph"> </div>

    This file contains contract function definitions.
    All contract types and utility functions are defined in <span class="inlinecode"><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#"><span class="id" title="library">ConCert.Examples.BAT.BATCommon</span></a></span>.
    Proofs for this contract can be found in <span class="inlinecode"><span class="id" title="library">ConCert.Examples.BAT.BATFixedCorrect</span></span>.

<div class="paragraph"> </div>

    The BAT contract is a combination of a EIP20 token contract and a crowdsale contract.
    This implementation extends the EIP20 contract implemented in <span class="inlinecode"><a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#"><span class="id" title="library">ConCert.Examples.EIP20.EIP20Token</span></a></span>.

</div>
<div class="code">
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#"><span class="id" title="library">List</span></a>. <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ListNotations"><span class="id" title="module">ListNotations</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.ZArith_base.html#"><span class="id" title="library">ZArith_base</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Utils.Extras.html#"><span class="id" title="library">Extras</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Utils.RecordUpdate.html#"><span class="id" title="library">RecordUpdate</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Blockchain.html#"><span class="id" title="library">Blockchain</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Containers.html#"><span class="id" title="library">Containers</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Monad.html#"><span class="id" title="library">Monad</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Serializable.html#"><span class="id" title="library">Serializable</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.ResultMonad.html#"><span class="id" title="library">ResultMonad</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.ContractCommon.html#"><span class="id" title="library">ContractCommon</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#"><span class="id" title="library">BATCommon</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.EIP20</span> <span class="id" title="keyword">Require</span> <a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#"><span class="id" title="library">EIP20Token</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a id="lab169"></a><h1 class="section">Contract functions</h1>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <a id="BATFixed" class="idref" href="#BATFixed"><span class="id" title="section">BATFixed</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Context</span> {<a id="BaseTypes:1" class="idref" href="#BaseTypes:1"><span class="id" title="binder">BaseTypes</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ChainBase"><span class="id" title="class">ChainBase</span></a>}.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">N_scope</span>.<br/>
</div>

<div class="doc">
<a id="lab170"></a><h2 class="section">Init</h2>
 This function only gets called once when contract is deployed.
      Will set up the initial storage state of the contract.
  
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="init" class="idref" href="#init"><span class="id" title="definition">init</span></a> (<a id="chain:2" class="idref" href="#chain:2"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="ctx:3" class="idref" href="#ctx:3"><span class="id" title="binder">ctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="setup:4" class="idref" href="#setup:4"><span class="id" title="binder">setup</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Setup"><span class="id" title="record">Setup</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="ConCert.Execution.ResultMonad.html#result"><span class="id" title="inductive">result</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Error"><span class="id" title="definition">Error</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
BAToken should not be deployable if one of the following conditions does not hold on <span class="inlinecode"><a class="idref" href="ConCert.Examples.Congress.tests.CongressTests.html#setup"><span class="id" title="definition">setup</span></a></span>
<ul class="doclist">
<li> funding period is non empty

</li>
<li> funding period does not start before the slot where the contract is deployed

</li>
<li> minimum tokens to fund should not be less than the maximum tokens allowed

</li>
<li> the initial supply of tokens should be less than the maximum tokens allowed

</li>
<li> token exchange rate must be larger than 0

</li>
<li> it must be possible to get over minimum token bound without going over maximum

</li>
</ul>
        For the last condition we check that <span class="inlinecode"><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a></span> <span class="inlinecode">&lt;=</span> <span class="inlinecode"><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationCap"><span class="id" title="projection">tokenCreationCap</span></a></span> <span class="inlinecode">-</span> <span class="inlinecode"><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationMin"><span class="id" title="projection">tokenCreationMin</span></a></span>,
        however this does exclude a few possible configurations where the contract still works as intended.
        However, these are not likely to come up in real usecases.
    
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> ((<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_fundingEnd"><span class="id" title="projection">_fundingEnd</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#0f31f5c1c6b6a21a3a187247222bc9e4"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_fundingStart"><span class="id" title="projection">_fundingStart</span></a>))%<span class="id" title="var">nat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_fundingStart"><span class="id" title="projection">_fundingStart</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#6b7621b45fff0af5e2b2cbb2bc2d4e1d"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#chain:2"><span class="id" title="variable">chain</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#current_slot"><span class="id" title="projection">current_slot</span></a>))%<span class="id" title="var">nat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenCreationCap"><span class="id" title="projection">_tokenCreationCap</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#b39870dee55afcd85c6b795fb34de165"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenCreationMin"><span class="id" title="projection">_tokenCreationMin</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenCreationCap"><span class="id" title="projection">_tokenCreationCap</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#b39870dee55afcd85c6b795fb34de165"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_batFund"><span class="id" title="projection">_batFund</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenExchangeRate"><span class="id" title="projection">_tokenExchangeRate</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> 0<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#b39870dee55afcd85c6b795fb34de165"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenCreationCap"><span class="id" title="projection">_tokenCreationCap</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">-</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenCreationMin"><span class="id" title="projection">_tokenCreationMin</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#b39870dee55afcd85c6b795fb34de165"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#b39870dee55afcd85c6b795fb34de165"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenExchangeRate"><span class="id" title="projection">_tokenExchangeRate</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_batFundDeposit"><span class="id" title="projection">_batFundDeposit</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#ctx:3"><span class="id" title="variable">ctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_contract_address"><span class="id" title="projection">ctx_contract_address</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_fundDeposit"><span class="id" title="projection">_fundDeposit</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#ctx:3"><span class="id" title="variable">ctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_contract_address"><span class="id" title="projection">ctx_contract_address</span></a>)) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="token_state:5" class="idref" href="#token_state:5"><span class="id" title="binder">token_state</span></a> := {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#balances"><span class="id" title="projection">EIP20Token.balances</span></a> := <a class="idref" href="ConCert.Execution.Containers.html#FMap.add"><span class="id" title="abbreviation">FMap.add</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_batFundDeposit"><span class="id" title="projection">_batFundDeposit</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_batFund"><span class="id" title="projection">_batFund</span></a>) <a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#total_supply"><span class="id" title="projection">EIP20Token.total_supply</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_batFund"><span class="id" title="projection">_batFund</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#allowances"><span class="id" title="projection">EIP20Token.allowances</span></a> := <a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">Ok</span></a> {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
EIP20Token initialisation: 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#token_state"><span class="id" title="projection">token_state</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#token_state:5"><span class="id" title="variable">token_state</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
BAT initialisation: 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#initSupply"><span class="id" title="projection">initSupply</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_batFund"><span class="id" title="projection">_batFund</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundDeposit"><span class="id" title="projection">fundDeposit</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_fundDeposit"><span class="id" title="projection">_fundDeposit</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#batFundDeposit"><span class="id" title="projection">batFundDeposit</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_batFundDeposit"><span class="id" title="projection">_batFundDeposit</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingStart"><span class="id" title="projection">fundingStart</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_fundingStart"><span class="id" title="projection">_fundingStart</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingEnd"><span class="id" title="projection">fundingEnd</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_fundingEnd"><span class="id" title="projection">_fundingEnd</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenExchangeRate"><span class="id" title="projection">_tokenExchangeRate</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationCap"><span class="id" title="projection">tokenCreationCap</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenCreationCap"><span class="id" title="projection">_tokenCreationCap</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationMin"><span class="id" title="projection">tokenCreationMin</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#setup:4"><span class="id" title="variable">setup</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#_tokenCreationMin"><span class="id" title="projection">_tokenCreationMin</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|}.<br/>

<br/>
</div>

<div class="doc">
<a id="lab171"></a><h2 class="section">Create Tokens</h2>
 This entrypoint allows users to fund the crowdsale in return for tokens 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="try_create_tokens" class="idref" href="#try_create_tokens"><span class="id" title="definition">try_create_tokens</span></a> (<a id="sender:6" class="idref" href="#sender:6"><span class="id" title="binder">sender</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="sender_payload:7" class="idref" href="#sender_payload:7"><span class="id" title="binder">sender_payload</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Amount"><span class="id" title="definition">Amount</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="current_slot:8" class="idref" href="#current_slot:8"><span class="id" title="binder">current_slot</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="state:9" class="idref" href="#state:9"><span class="id" title="binder">state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="ConCert.Execution.ResultMonad.html#result"><span class="id" title="inductive">result</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Error"><span class="id" title="definition">Error</span></a> :=<br/>
&nbsp;&nbsp;</div>

<div class="doc">
Early return if funding is finalized, funding period hasn't started yet,
      or funding period is over 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#Nat.ltb"><span class="id" title="definition">Nat.ltb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#current_slot:8"><span class="id" title="variable">current_slot</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingStart"><span class="id" title="projection">fundingStart</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#Nat.ltb"><span class="id" title="definition">Nat.ltb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingEnd"><span class="id" title="projection">fundingEnd</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#current_slot:8"><span class="id" title="variable">current_slot</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:6"><span class="id" title="variable">sender</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#batFundDeposit"><span class="id" title="projection">batFundDeposit</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
Here we deviate slightly from the reference implementation. They only check for = 0,
        but since ConCert's payloads may be negative numbers, we must extend this check to &lt;= 0 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.leb"><span class="id" title="definition">Z.leb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender_payload:7"><span class="id" title="variable">sender_payload</span></a> 0) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
Note: this conversion from Z to N is safe because by assumption sender_payload &gt; 0 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="tokens:10" class="idref" href="#tokens:10"><span class="id" title="binder">tokens</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#fe1417cc32a1703619b26940ce957c6a"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.to_N"><span class="id" title="definition">Z.to_N</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender_payload:7"><span class="id" title="variable">sender_payload</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#fe1417cc32a1703619b26940ce957c6a"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#fe1417cc32a1703619b26940ce957c6a"><span class="id" title="notation">*</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="checkedSupply:11" class="idref" href="#checkedSupply:11"><span class="id" title="binder">checkedSupply</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#tokens:10"><span class="id" title="variable">tokens</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationCap"><span class="id" title="projection">tokenCreationCap</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#b39870dee55afcd85c6b795fb34de165"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#checkedSupply:11"><span class="id" title="variable">checkedSupply</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="new_token_state:13" class="idref" href="#new_token_state:13"><span class="id" title="binder">new_token_state</span></a> : <a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#State"><span class="id" title="record">EIP20Token.State</span></a> := {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#total_supply"><span class="id" title="projection">EIP20Token.total_supply</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#checkedSupply:11"><span class="id" title="variable">checkedSupply</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#balances"><span class="id" title="projection">EIP20Token.balances</span></a> := <a class="idref" href="ConCert.Execution.Containers.html#FMap.partial_alter"><span class="id" title="abbreviation">FMap.partial_alter</span></a> (<span class="id" title="keyword">fun</span> <a id="balance:12" class="idref" href="#balance:12"><span class="id" title="binder">balance</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#balance:12"><span class="id" title="variable">balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#tokens:10"><span class="id" title="variable">tokens</span></a>)) <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:6"><span class="id" title="variable">sender</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#allowances"><span class="id" title="projection">EIP20Token.allowances</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">Ok</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:9"><span class="id" title="variable">state</span></a><a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">&lt;|</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#token_state"><span class="id" title="projection">token_state</span></a> <a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">:=</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#new_token_state:13"><span class="id" title="variable">new_token_state</span></a><a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">|&gt;</span></a>).<br/>

<br/>
</div>

<div class="doc">
<a id="lab172"></a><h2 class="section">Refund</h2>
 This entrypoint can be called if crowdsale is not successfully funded.
      Users calling this entrypoint will have their tokens removed and get their money refunded.
  
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="try_refund" class="idref" href="#try_refund"><span class="id" title="definition">try_refund</span></a> (<a id="sender:14" class="idref" href="#sender:14"><span class="id" title="binder">sender</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="current_slot:15" class="idref" href="#current_slot:15"><span class="id" title="binder">current_slot</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="state:16" class="idref" href="#state:16"><span class="id" title="binder">state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="ConCert.Execution.ResultMonad.html#result"><span class="id" title="inductive">result</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Error"><span class="id" title="definition">Error</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
Early return if funding is finalized, or funding period is NOT over,
        or if total supply exceeds or is equal to the minimum fund tokens. 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#Nat.leb"><span class="id" title="definition">Nat.leb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#current_slot:15"><span class="id" title="variable">current_slot</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingEnd"><span class="id" title="projection">fundingEnd</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationMin"><span class="id" title="projection">tokenCreationMin</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
Don't allow the the batFundDeposit account to refund 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> (<a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:14"><span class="id" title="variable">sender</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#batFundDeposit"><span class="id" title="projection">batFundDeposit</span></a>)) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <a id="sender_bats:17" class="idref" href="#sender_bats:17"><span class="id" title="binder">sender_bats</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ResultMonad.html#result_of_option"><span class="id" title="definition">result_of_option</span></a> (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:14"><span class="id" title="variable">sender</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a>)) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender_bats:17"><span class="id" title="variable">sender_bats</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> 0) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="new_total_supply:18" class="idref" href="#new_total_supply:18"><span class="id" title="binder">new_total_supply</span></a> := (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">-</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender_bats:17"><span class="id" title="variable">sender_bats</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
Convert tokens back to the currency of the blockchain, to be sent back to the sender address 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount_to_send:19" class="idref" href="#amount_to_send:19"><span class="id" title="binder">amount_to_send</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">Z.of_N</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender_bats:17"><span class="id" title="variable">sender_bats</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#be3f246709fdc565d9577f86645e6da3"><span class="id" title="notation">/</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="new_token_state:20" class="idref" href="#new_token_state:20"><span class="id" title="binder">new_token_state</span></a> : <a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#State"><span class="id" title="record">EIP20Token.State</span></a> := {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#total_supply"><span class="id" title="projection">EIP20Token.total_supply</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#new_total_supply:18"><span class="id" title="variable">new_total_supply</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#balances"><span class="id" title="projection">EIP20Token.balances</span></a> := <a class="idref" href="ConCert.Execution.Containers.html#FMap.add"><span class="id" title="abbreviation">FMap.add</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:14"><span class="id" title="variable">sender</span></a> 0 (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#allowances"><span class="id" title="projection">EIP20Token.allowances</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="new_state:21" class="idref" href="#new_state:21"><span class="id" title="binder">new_state</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:16"><span class="id" title="variable">state</span></a><a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">&lt;|</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#token_state"><span class="id" title="projection">token_state</span></a> <a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">:=</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#new_token_state:20"><span class="id" title="variable">new_token_state</span></a><a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">|&gt;</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="send_act:22" class="idref" href="#send_act:22"><span class="id" title="binder">send_act</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#act_transfer"><span class="id" title="constructor">act_transfer</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:14"><span class="id" title="variable">sender</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#amount_to_send:19"><span class="id" title="variable">amount_to_send</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">Ok</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#new_state:21"><span class="id" title="variable">new_state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#send_act:22"><span class="id" title="variable">send_act</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a id="lab173"></a><h2 class="section">Finalize</h2>
 This entrypoint will end the crowdsale and pay out the money to the owner.
      Can only be called if funding was successful.
  
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="try_finalize" class="idref" href="#try_finalize"><span class="id" title="definition">try_finalize</span></a> (<a id="sender:23" class="idref" href="#sender:23"><span class="id" title="binder">sender</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="current_slot:24" class="idref" href="#current_slot:24"><span class="id" title="binder">current_slot</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="contract_balance:25" class="idref" href="#contract_balance:25"><span class="id" title="binder">contract_balance</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Amount"><span class="id" title="definition">Amount</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="state:26" class="idref" href="#state:26"><span class="id" title="binder">state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="ConCert.Execution.ResultMonad.html#result"><span class="id" title="inductive">result</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Error"><span class="id" title="definition">Error</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
Early return if funding is finalized, or if sender is NOT the fund deposit address,
        or if the total token supply is less than the minimum required amount,
        or if it is too early to end funding and the total token supply has not reached the cap.
        Note: the last requirement makes it possible to end a funding early if the cap has been reached.
    
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:26"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> (<a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:23"><span class="id" title="variable">sender</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:26"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundDeposit"><span class="id" title="projection">fundDeposit</span></a>))<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#b39870dee55afcd85c6b795fb34de165"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:26"><span class="id" title="variable">state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#b39870dee55afcd85c6b795fb34de165"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#b39870dee55afcd85c6b795fb34de165"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:26"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationMin"><span class="id" title="projection">tokenCreationMin</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#Nat.leb"><span class="id" title="definition">Nat.leb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#current_slot:24"><span class="id" title="variable">current_slot</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:26"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingEnd"><span class="id" title="projection">fundingEnd</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:26"><span class="id" title="variable">state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:26"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationCap"><span class="id" title="projection">tokenCreationCap</span></a>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
Send the currency of the contract back to the fund 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="send_act:27" class="idref" href="#send_act:27"><span class="id" title="binder">send_act</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#act_transfer"><span class="id" title="constructor">act_transfer</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:26"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundDeposit"><span class="id" title="projection">fundDeposit</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#contract_balance:25"><span class="id" title="variable">contract_balance</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="new_state:28" class="idref" href="#new_state:28"><span class="id" title="binder">new_state</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:26"><span class="id" title="variable">state</span></a><a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">&lt;|</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a> <a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">:=</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">|&gt;</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">Ok</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#new_state:28"><span class="id" title="variable">new_state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#send_act:27"><span class="id" title="variable">send_act</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a>.<br/>

<br/>
</div>

<div class="doc">
<a id="lab174"></a><h2 class="section">Receive</h2>
 This is the main entrypoint function.
      All contract calls will be handled by this function
  
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">Z_scope</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="receive_bat" class="idref" href="#receive_bat"><span class="id" title="definition">receive_bat</span></a> (<a id="chain:29" class="idref" href="#chain:29"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="ctx:30" class="idref" href="#ctx:30"><span class="id" title="binder">ctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="state:31" class="idref" href="#state:31"><span class="id" title="binder">state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="maybe_msg:32" class="idref" href="#maybe_msg:32"><span class="id" title="binder">maybe_msg</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="ConCert.Execution.ResultMonad.html#result"><span class="id" title="inductive">result</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Error"><span class="id" title="definition">Error</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="sender:33" class="idref" href="#sender:33"><span class="id" title="binder">sender</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#ctx:30"><span class="id" title="variable">ctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="sender_payload:34" class="idref" href="#sender_payload:34"><span class="id" title="binder">sender_payload</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#ctx:30"><span class="id" title="variable">ctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_amount"><span class="id" title="projection">ctx_amount</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="slot:35" class="idref" href="#slot:35"><span class="id" title="binder">slot</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#chain:29"><span class="id" title="variable">chain</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#current_slot"><span class="id" title="projection">current_slot</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="contract_balance:36" class="idref" href="#contract_balance:36"><span class="id" title="binder">contract_balance</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#ctx:30"><span class="id" title="variable">ctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_contract_balance"><span class="id" title="projection">ctx_contract_balance</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#maybe_msg:32"><span class="id" title="variable">maybe_msg</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#create_tokens"><span class="id" title="constructor">create_tokens</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ContractCommon.html#without_actions"><span class="id" title="definition">without_actions</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#try_create_tokens"><span class="id" title="definition">try_create_tokens</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:33"><span class="id" title="variable">sender</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender_payload:34"><span class="id" title="variable">sender_payload</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#slot:35"><span class="id" title="variable">slot</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:31"><span class="id" title="variable">state</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#refund"><span class="id" title="constructor">refund</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ContractCommon.html#not_payable"><span class="id" title="definition">not_payable</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#ctx:30"><span class="id" title="variable">ctx</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#try_refund"><span class="id" title="definition">try_refund</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:33"><span class="id" title="variable">sender</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#slot:35"><span class="id" title="variable">slot</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:31"><span class="id" title="variable">state</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#finalize"><span class="id" title="constructor">finalize</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ContractCommon.html#not_payable"><span class="id" title="definition">not_payable</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#ctx:30"><span class="id" title="variable">ctx</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATFixed.html#try_finalize"><span class="id" title="definition">try_finalize</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#sender:33"><span class="id" title="variable">sender</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#slot:35"><span class="id" title="variable">slot</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#contract_balance:36"><span class="id" title="variable">contract_balance</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:31"><span class="id" title="variable">state</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <a class="idref" href="ConCert.Execution.ResultMonad.html#Err"><span class="id" title="constructor">Err</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Close</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">Z_scope</span>.<br/>

<br/>
</div>

<div class="doc">
Composes EIP20Token.receive and receive_bat by first executing
      EIP20Token.receive (if the message is an EIP20 message),
      and otherwise executes receive_bat 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="receive" class="idref" href="#receive"><span class="id" title="definition">receive</span></a> (<a id="chain:38" class="idref" href="#chain:38"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="ctx:39" class="idref" href="#ctx:39"><span class="id" title="binder">ctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="state:40" class="idref" href="#state:40"><span class="id" title="binder">state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="maybe_msg:41" class="idref" href="#maybe_msg:41"><span class="id" title="binder">maybe_msg</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="ConCert.Execution.ResultMonad.html#result"><span class="id" title="inductive">result</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Error"><span class="id" title="definition">Error</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#maybe_msg:41"><span class="id" title="variable">maybe_msg</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> <span class="id" title="var">msg</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.ContractCommon.html#throwIf"><span class="id" title="definition">throwIf</span></a> (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:40"><span class="id" title="variable">state</span></a>)) <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#default_error"><span class="id" title="definition">default_error</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <a id="res:43" class="idref" href="#res:43"><span class="id" title="binder">res</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#receive"><span class="id" title="definition">EIP20Token.receive</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#chain:38"><span class="id" title="variable">chain</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#ctx:39"><span class="id" title="variable">ctx</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:40"><span class="id" title="variable">state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#token_state"><span class="id" title="projection">token_state</span></a>) (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">msg</span>) <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="new_state:44" class="idref" href="#new_state:44"><span class="id" title="binder">new_state</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:40"><span class="id" title="variable">state</span></a><a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">&lt;|</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#token_state"><span class="id" title="projection">token_state</span></a> <a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">:=</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#fst"><span class="id" title="definition">fst</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#res:43"><span class="id" title="variable">res</span></a><a class="idref" href="ConCert.Utils.RecordSet.html#f46003504e2d2076ab5611d27918b097"><span class="id" title="notation">|&gt;</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">Ok</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATFixed.html#new_state:44"><span class="id" title="variable">new_state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#snd"><span class="id" title="definition">snd</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#res:43"><span class="id" title="variable">res</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#receive_bat"><span class="id" title="definition">receive_bat</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#chain:38"><span class="id" title="variable">chain</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#ctx:39"><span class="id" title="variable">ctx</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#state:40"><span class="id" title="variable">state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#maybe_msg:41"><span class="id" title="variable">maybe_msg</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="contract" class="idref" href="#contract"><span class="id" title="definition">contract</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Contract"><span class="id" title="record">Contract</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Setup"><span class="id" title="record">Setup</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Error"><span class="id" title="definition">Error</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Blockchain.html#build_contract"><span class="id" title="constructor">build_contract</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#init"><span class="id" title="definition">init</span></a> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#receive"><span class="id" title="definition">receive</span></a>.<br/>

<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="ConCert.Examples.BAT.BATFixed.html#BATFixed"><span class="id" title="section">BATFixed</span></a>.<br/>
</div>
</div>
<div id="footer">
  Generated by <a href="https://coq.inria.fr/">coqdoc</a> and improved with <a href="https://github.com/tebbi/coqdocjs">CoqdocJS</a> and <a href="https://github.com/jgallen23/toc">TOC</a>
</div>
</div>
<script>
  const elements = document.getElementsByClassName("libtitle");
  while(elements.length > 0){
        elements[0].parentNode.removeChild(elements[0]);
  }
  if (window.location.pathname.endsWith("/toc.html")) {
      const jstocDiv = document.getElementById("js-toc");
      jstocDiv.classList.remove("toc");
      jstocDiv.classList.add("jstoc-hidden");
      const jstocHeaderDiv = document.getElementById("js-toc-header");
      jstocHeaderDiv.classList.add("jstoc-hidden");
      const mainDiv = document.getElementById("main");
      mainDiv.classList.add("jstoc-hidden-main");
      const toggleDiv = document.getElementById("toggle-toc");
      toggleDiv.classList.add("jstoc-hidden");
  }
  console.log(window.location.pathname);
</script>
<script type="text/javascript" src="toc.js"></script>
</body>

</html>
