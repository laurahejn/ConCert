<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<link href="coqdocjs.css" rel="stylesheet" type="text/css"/>
<link href="toc.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="coqdocjs.js"></script>
</head>

<body onload="document.getElementById('content').focus()">
  <div id="header">
    <span class="left">
      <span class="modulename"> <script> document.write(document.title) </script> </span>
      <span id="toggle-toc">Contents</span>
    </span>

    <span class="button" id="toggle-proofs"></span>

    <span class="right">
      <a href="https://github.com/AU-COBRA/ConCert" target="_balnk">Project Page</a>
      <a href="index.html">Index</a>
      <a href="toc.html">Table of contents</a>
    </span>
</div>
  <div id="content" tabindex="-1" onblur="document.getElementById('content').focus()">
    <div id="js-toc" class="toc" data-toc="h1,h2,h3,h4" data-toc-container="doc" data-toc-offset="-40">
      <div id="js-toc-header" class="toc-header">Contents:</div>
    </div>
    <div id="main">
<h1 class="libtitle">Library ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests</h1>

<div class="code">
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Blockchain.html#"><span class="id" title="library">Blockchain</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Serializable.html#"><span class="id" title="library">Serializable</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Containers.html#"><span class="id" title="library">Containers</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.ContractCommon.html#"><span class="id" title="library">ContractCommon</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Monad.html#"><span class="id" title="library">Monad</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.ResultMonad.html#"><span class="id" title="library">ResultMonad</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution.Test</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Test.QCTest.html#"><span class="id" title="library">QCTest</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution.Test</span> <span class="id" title="keyword">Require</span> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#"><span class="id" title="library">TestUtils</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.FA2</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.FA2.FA2Token.html#"><span class="id" title="library">FA2Token</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.FA2</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#"><span class="id" title="library">FA2LegacyInterface</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.ExchangeBuggy</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#"><span class="id" title="library">ExchangeBuggy</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.ExchangeBuggy</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyGens.html#"><span class="id" title="library">ExchangeBuggyGens</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.ExchangeBuggy</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Export</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyPrinters.html#"><span class="id" title="library">ExchangeBuggyPrinters</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Utils.Extras.html#"><span class="id" title="library">Extras</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.ZArith.html#"><span class="id" title="library">ZArith</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#"><span class="id" title="library">List</span></a>.<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ListNotations"><span class="id" title="module">ListNotations</span></a>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="exchange_token_id" class="idref" href="#exchange_token_id"><span class="id" title="definition">exchange_token_id</span></a> := 0%<span class="id" title="var">N</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="fa2_caddr" class="idref" href="#fa2_caddr"><span class="id" title="definition">fa2_caddr</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#addr_of_Z"><span class="id" title="definition">addr_of_Z</span></a> 128.<br/>
<span class="id" title="keyword">Definition</span> <a id="exchange_caddr" class="idref" href="#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#addr_of_Z"><span class="id" title="definition">addr_of_Z</span></a> 129.<br/>
<span class="id" title="keyword">Definition</span> <a id="exploit_caddr" class="idref" href="#exploit_caddr"><span class="id" title="definition">exploit_caddr</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#addr_of_Z"><span class="id" title="definition">addr_of_Z</span></a> 130.<br/>

<br/>
<span class="id" title="keyword">Section</span> <a id="ExplotContract" class="idref" href="#ExplotContract"><span class="id" title="section">ExplotContract</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="ExploitContractMsg" class="idref" href="#ExploitContractMsg"><span class="id" title="definition">ExploitContractMsg</span></a> := <a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#fa2_token_sender"><span class="id" title="inductive">fa2_token_sender</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="ExploitContractState" class="idref" href="#ExploitContractState"><span class="id" title="definition">ExploitContractState</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="ExplotContractSetup" class="idref" href="#ExplotContractSetup"><span class="id" title="definition">ExplotContractSetup</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#unit"><span class="id" title="inductive">unit</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="ExplotContractError" class="idref" href="#ExplotContractError"><span class="id" title="definition">ExplotContractError</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#unit"><span class="id" title="inductive">unit</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="exploit_init" class="idref" href="#exploit_init"><span class="id" title="definition">exploit_init</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="chain:1" class="idref" href="#chain:1"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="ctx:2" class="idref" href="#ctx:2"><span class="id" title="binder">ctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="setup:3" class="idref" href="#setup:3"><span class="id" title="binder">setup</span></a> : <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExplotContractSetup"><span class="id" title="definition">ExplotContractSetup</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="ConCert.Execution.ResultMonad.html#result"><span class="id" title="inductive">result</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExploitContractState"><span class="id" title="definition">ExploitContractState</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExplotContractError"><span class="id" title="definition">ExplotContractError</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">Ok</span></a> 1.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="exploit_receive" class="idref" href="#exploit_receive"><span class="id" title="definition">exploit_receive</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="chain:4" class="idref" href="#chain:4"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="ctx:5" class="idref" href="#ctx:5"><span class="id" title="binder">ctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="state:6" class="idref" href="#state:6"><span class="id" title="binder">state</span></a> : <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExploitContractState"><span class="id" title="definition">ExploitContractState</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="maybe_msg:7" class="idref" href="#maybe_msg:7"><span class="id" title="binder">maybe_msg</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExploitContractMsg"><span class="id" title="definition">ExploitContractMsg</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="ConCert.Execution.ResultMonad.html#result"><span class="id" title="inductive">result</span></a> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExploitContractState"><span class="id" title="definition">ExploitContractState</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>) <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExplotContractError"><span class="id" title="definition">ExplotContractError</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#maybe_msg:7"><span class="id" title="variable">maybe_msg</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#tokens_sent"><span class="id" title="constructor">tokens_sent</span></a> <span class="id" title="var">param</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> 5 <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#6b7621b45fff0af5e2b2cbb2bc2d4e1d"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#state:6"><span class="id" title="variable">state</span></a> <span class="comment">(*&nbsp;Repeat&nbsp;reentrancy&nbsp;up&nbsp;to&nbsp;five&nbsp;times&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">Ok</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#state:6"><span class="id" title="variable">state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="token_exchange_msg:9" class="idref" href="#token_exchange_msg:9"><span class="id" title="binder">token_exchange_msg</span></a> := <a class="idref" href="ConCert.Examples.FA2.FA2Token.html#other_msg"><span class="id" title="constructor">other_msg</span></a> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#tokens_to_asset"><span class="id" title="constructor">tokens_to_asset</span></a> {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#exchange_owner"><span class="id" title="projection">exchange_owner</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#exchange_token_id"><span class="id" title="projection">ExchangeBuggy.exchange_token_id</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_token_id"><span class="id" title="definition">exchange_token_id</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#tokens_sold"><span class="id" title="projection">tokens_sold</span></a> := 200%<span class="id" title="var">N</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#callback_addr"><span class="id" title="projection">callback_addr</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ctx:5"><span class="id" title="variable">ctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_contract_address"><span class="id" title="projection">ctx_contract_address</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|}) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">Ok</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#state:6"><span class="id" title="variable">state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Peano.html#0dacc1786c5ba797d47dd85006231633"><span class="id" title="notation">+</span></a> 1<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Execution.Blockchain.html#act_call"><span class="id" title="constructor">act_call</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a> 0 (<a class="idref" href="ConCert.Execution.Serializable.html#serialize"><span class="id" title="method">serialize</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#token_exchange_msg:9"><span class="id" title="variable">token_exchange_msg</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">Ok</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#state:6"><span class="id" title="variable">state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="exploit_contract" class="idref" href="#exploit_contract"><span class="id" title="definition">exploit_contract</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Contract"><span class="id" title="record">Contract</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExplotContractSetup"><span class="id" title="definition">ExplotContractSetup</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExploitContractMsg"><span class="id" title="definition">ExploitContractMsg</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExploitContractState"><span class="id" title="definition">ExploitContractState</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExplotContractError"><span class="id" title="definition">ExplotContractError</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Blockchain.html#build_contract"><span class="id" title="constructor">build_contract</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exploit_init"><span class="id" title="definition">exploit_init</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exploit_receive"><span class="id" title="definition">exploit_receive</span></a>.<br/>

<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#ExplotContract"><span class="id" title="section">ExplotContract</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;The&nbsp;policy&nbsp;which&nbsp;allows&nbsp;both&nbsp;owners&nbsp;and&nbsp;operators&nbsp;to&nbsp;transfer&nbsp;tokens.&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="policy_all" class="idref" href="#policy_all"><span class="id" title="definition">policy_all</span></a> : <a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#permissions_descriptor"><span class="id" title="record">permissions_descriptor</span></a> := {|<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#descr_self"><span class="id" title="projection">descr_self</span></a> := <a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#self_transfer_permitted"><span class="id" title="constructor">self_transfer_permitted</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#descr_operator"><span class="id" title="projection">descr_operator</span></a> := <a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#operator_transfer_permitted"><span class="id" title="constructor">operator_transfer_permitted</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#descr_sender"><span class="id" title="projection">descr_sender</span></a> := <a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#owner_no_op"><span class="id" title="constructor">owner_no_op</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#descr_receiver"><span class="id" title="projection">descr_receiver</span></a> := <a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#owner_no_op"><span class="id" title="constructor">owner_no_op</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#descr_custom"><span class="id" title="projection">descr_custom</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a>;<br/>
|}.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="token_metadata_0" class="idref" href="#token_metadata_0"><span class="id" title="definition">token_metadata_0</span></a> : <a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#token_metadata"><span class="id" title="record">token_metadata</span></a> := {|<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#metadata_token_id"><span class="id" title="projection">metadata_token_id</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_token_id"><span class="id" title="definition">exchange_token_id</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#metadata_decimals"><span class="id" title="projection">metadata_decimals</span></a> := 8%<span class="id" title="var">N</span>;<br/>
|}.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="token_setup" class="idref" href="#token_setup"><span class="id" title="definition">token_setup</span></a> : <a class="idref" href="ConCert.Examples.FA2.FA2Token.html#Setup"><span class="id" title="record">FA2Token.Setup</span></a> := {|<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2Token.html#transfer_hook_addr_"><span class="id" title="projection">transfer_hook_addr_</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2Token.html#setup_total_supply"><span class="id" title="projection">setup_total_supply</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2Token.html#setup_tokens"><span class="id" title="projection">setup_tokens</span></a> := <a class="idref" href="ConCert.Execution.Containers.html#FMap.add"><span class="id" title="abbreviation">FMap.add</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_token_id"><span class="id" title="definition">exchange_token_id</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#token_metadata_0"><span class="id" title="definition">token_metadata_0</span></a> <a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2Token.html#initial_permission_policy"><span class="id" title="projection">initial_permission_policy</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#policy_all"><span class="id" title="definition">policy_all</span></a>;<br/>
|}.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="exchange_setup" class="idref" href="#exchange_setup"><span class="id" title="definition">exchange_setup</span></a> : <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#Setup"><span class="id" title="record">ExchangeBuggy.Setup</span></a> := {|<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#fa2_caddr_"><span class="id" title="projection">fa2_caddr_</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#fa2_caddr"><span class="id" title="definition">fa2_caddr</span></a>;<br/>
|}.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="exchange_other_msg" class="idref" href="#exchange_other_msg"><span class="id" title="definition">exchange_other_msg</span></a> := @<a class="idref" href="ConCert.Examples.FA2.FA2Token.html#other_msg"><span class="id" title="constructor">other_msg</span></a> <span class="id" title="var">_</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#ExchangeMsg"><span class="id" title="inductive">ExchangeMsg</span></a>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="add_operator_all" class="idref" href="#add_operator_all"><span class="id" title="definition">add_operator_all</span></a> <a id="owner:10" class="idref" href="#owner:10"><span class="id" title="binder">owner</span></a> <a id="operator:11" class="idref" href="#operator:11"><span class="id" title="binder">operator</span></a> := {|<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#op_param_owner"><span class="id" title="projection">op_param_owner</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#owner:10"><span class="id" title="variable">owner</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#op_param_operator"><span class="id" title="projection">op_param_operator</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#operator:11"><span class="id" title="variable">operator</span></a>;<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#op_param_tokens"><span class="id" title="projection">op_param_tokens</span></a> := <a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#all_tokens"><span class="id" title="constructor">all_tokens</span></a>;<br/>
|}.<br/>

<br/>
<span class="comment">(*&nbsp;Setup&nbsp;a&nbsp;chain&nbsp;with&nbsp;FA2&nbsp;contract,&nbsp;exchange&nbsp;contract,&nbsp;and&nbsp;exploit&nbsp;contract&nbsp;deployed.<br/>
&nbsp;&nbsp;&nbsp;Also&nbsp;adds&nbsp;some&nbsp;tokens&nbsp;to&nbsp;person_1&nbsp;and&nbsp;exchange&nbsp;contract,&nbsp;and&nbsp;adds&nbsp;some&nbsp;operators&nbsp;on&nbsp;the&nbsp;fa2&nbsp;contract&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="chain" class="idref" href="#chain"><span class="id" title="definition">chain</span></a> : <a class="idref" href="ConCert.Execution.Test.TestUtils.html#ChainBuilder"><span class="id" title="instance">ChainBuilder</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#unpack_result"><span class="id" title="definition">unpack_result</span></a> (<a class="idref" href="ConCert.Execution.Test.TraceGens.html#add_block"><span class="id" title="definition">TraceGens.add_block</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#builder_initial"><span class="id" title="method">builder_initial</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a> <span class="comment">(*&nbsp;Give&nbsp;10&nbsp;to&nbsp;person&nbsp;1&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">TestUtils.build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> 10 <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Deploy&nbsp;contracts&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_deploy"><span class="id" title="definition">build_deploy</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> 0 <a class="idref" href="ConCert.Examples.FA2.FA2Token.html#contract"><span class="id" title="definition">FA2Token.contract</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#token_setup"><span class="id" title="definition">token_setup</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_deploy"><span class="id" title="definition">build_deploy</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> 30 <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#contract"><span class="id" title="definition">ExchangeBuggy.contract</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_setup"><span class="id" title="definition">exchange_setup</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_deploy"><span class="id" title="definition">build_deploy</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> 0 <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exploit_contract"><span class="id" title="definition">exploit_contract</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#tt"><span class="id" title="constructor">tt</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Person&nbsp;1&nbsp;creates&nbsp;1000&nbsp;tokens&nbsp;in&nbsp;FA2&nbsp;contract&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_call"><span class="id" title="definition">build_call</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#fa2_caddr"><span class="id" title="definition">fa2_caddr</span></a> 10 (<a class="idref" href="ConCert.Examples.FA2.FA2Token.html#msg_create_tokens"><span class="id" title="constructor">msg_create_tokens</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_token_id"><span class="id" title="definition">exchange_token_id</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Exchange&nbsp;contract&nbsp;creates&nbsp;1000&nbsp;tokens&nbsp;in&nbsp;FA2&nbsp;contract&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_call"><span class="id" title="definition">build_call</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a> 10<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_other_msg"><span class="id" title="definition">exchange_other_msg</span></a> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#add_to_tokens_reserve"><span class="id" title="constructor">add_to_tokens_reserve</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_token_id"><span class="id" title="definition">exchange_token_id</span></a>)) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Person&nbsp;1&nbsp;allows&nbsp;Exchange&nbsp;and&nbsp;exploit&nbsp;contracts&nbsp;to&nbsp;operate&nbsp;on&nbsp;its&nbsp;tokens&nbsp;in&nbsp;the&nbsp;FA2&nbsp;contract&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_call"><span class="id" title="definition">build_call</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#fa2_caddr"><span class="id" title="definition">fa2_caddr</span></a> 0 (<a class="idref" href="ConCert.Examples.FA2.FA2Token.html#msg_update_operators"><span class="id" title="constructor">msg_update_operators</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#add_operator"><span class="id" title="constructor">add_operator</span></a> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#add_operator_all"><span class="id" title="definition">add_operator_all</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exploit_caddr"><span class="id" title="definition">exploit_caddr</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#add_operator"><span class="id" title="constructor">add_operator</span></a> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#add_operator_all"><span class="id" title="definition">add_operator_all</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>)<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="exchange_state" class="idref" href="#exchange_state"><span class="id" title="definition">exchange_state</span></a> <a id="env:12" class="idref" href="#env:12"><span class="id" title="binder">env</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#State"><span class="id" title="record">ExchangeBuggy.State</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#env:12"><span class="id" title="variable">env</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a>.<br/>
<span class="id" title="keyword">Definition</span> <a id="token_state" class="idref" href="#token_state"><span class="id" title="definition">token_state</span></a> <a id="env:13" class="idref" href="#env:13"><span class="id" title="binder">env</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.FA2.FA2Token.html#State"><span class="id" title="record">FA2Token.State</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#env:13"><span class="id" title="variable">env</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#fa2_caddr"><span class="id" title="definition">fa2_caddr</span></a>.<br/>

<br/>
<span class="id" title="keyword">Module</span> <a id="TestInfo" class="idref" href="#TestInfo"><span class="id" title="module">TestInfo</span></a> &lt;: <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyGens.html#ExchangeTestsInfo"><span class="id" title="module">ExchangeTestsInfo</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.fa2_contract_addr" class="idref" href="#TestInfo.fa2_contract_addr"><span class="id" title="definition">fa2_contract_addr</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#fa2_caddr"><span class="id" title="definition">fa2_caddr</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.exchange_contract_addr" class="idref" href="#TestInfo.exchange_contract_addr"><span class="id" title="definition">exchange_contract_addr</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.exploit_contract_addr" class="idref" href="#TestInfo.exploit_contract_addr"><span class="id" title="definition">exploit_contract_addr</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exploit_caddr"><span class="id" title="definition">exploit_caddr</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.accounts" class="idref" href="#TestInfo.accounts"><span class="id" title="definition">accounts</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#test_chain_addrs_3"><span class="id" title="definition">test_chain_addrs_3</span></a>.<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#TestInfo"><span class="id" title="module">TestInfo</span></a>.<br/>
<span class="id" title="keyword">Module</span> <a id="MG" class="idref" href="#MG"><span class="id" title="module">MG</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyGens.html#ExchangeGens"><span class="id" title="module">ExchangeBuggyGens.ExchangeGens</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#TestInfo"><span class="id" title="module">TestInfo</span></a>. <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#MG"><span class="id" title="module">MG</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;Helper&nbsp;function&nbsp;that&nbsp;generates&nbsp;a&nbsp;call&nbsp;to&nbsp;the&nbsp;exploit&nbsp;contract&nbsp;to<br/>
&nbsp;&nbsp;&nbsp;initiate&nbsp;a&nbsp;token&nbsp;exchange&nbsp;on&nbsp;behalf&nbsp;of&nbsp;the&nbsp;caller.&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="call_exchange" class="idref" href="#call_exchange"><span class="id" title="definition">call_exchange</span></a> <a id="owner_addr:14" class="idref" href="#owner_addr:14"><span class="id" title="binder">owner_addr</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="dummy_descriptor:15" class="idref" href="#dummy_descriptor:15"><span class="id" title="binder">dummy_descriptor</span></a> := {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#transfer_descr_fa2"><span class="id" title="projection">transfer_descr_fa2</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#fa2_caddr"><span class="id" title="definition">fa2_caddr</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#transfer_descr_batch"><span class="id" title="projection">transfer_descr_batch</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#transfer_descr_operator"><span class="id" title="projection">transfer_descr_operator</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a>;<br/>
&nbsp;&nbsp;|} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_call"><span class="id" title="definition">build_call</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#owner_addr:14"><span class="id" title="variable">owner_addr</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exploit_caddr"><span class="id" title="definition">exploit_caddr</span></a> 0 (<a class="idref" href="ConCert.Examples.FA2.FA2LegacyInterface.html#tokens_sent"><span class="id" title="constructor">tokens_sent</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#dummy_descriptor:15"><span class="id" title="variable">dummy_descriptor</span></a>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="gExploitAction" class="idref" href="#gExploitAction"><span class="id" title="definition">gExploitAction</span></a> : <span class="id" title="definition">GOpt</span> <a class="idref" href="ConCert.Execution.Blockchain.html#Action"><span class="id" title="record">Action</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="axiom">bindGen</span> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#gTestAddrs3"><span class="id" title="definition">gTestAddrs3</span></a> (<span class="id" title="keyword">fun</span> <a id="addr:16" class="idref" href="#addr:16"><span class="id" title="binder">addr</span></a> =&gt; <a class="idref" href="ConCert.Execution.Test.TestUtils.html#returnGenSome"><span class="id" title="definition">returnGenSome</span></a> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#call_exchange"><span class="id" title="definition">call_exchange</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#addr:16"><span class="id" title="variable">addr</span></a>)).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="gExploitChainTraceList" class="idref" href="#gExploitChainTraceList"><span class="id" title="definition">gExploitChainTraceList</span></a> <a id="max_acts_per_block:17" class="idref" href="#max_acts_per_block:17"><span class="id" title="binder">max_acts_per_block</span></a> <a id="cb:18" class="idref" href="#cb:18"><span class="id" title="binder">cb</span></a> <a id="length:19" class="idref" href="#length:19"><span class="id" title="binder">length</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TraceGens.html#gChain"><span class="id" title="definition">TraceGens.gChain</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#cb:18"><span class="id" title="variable">cb</span></a> (<span class="id" title="keyword">fun</span> <a id="cb:20" class="idref" href="#cb:20"><span class="id" title="binder">cb</span></a> <span class="id" title="var">_</span> =&gt; <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#gExploitAction"><span class="id" title="definition">gExploitAction</span></a>) <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#length:19"><span class="id" title="variable">length</span></a> 1 <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#max_acts_per_block:17"><span class="id" title="variable">max_acts_per_block</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;Sample&nbsp;(gExploitAction).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Sample&nbsp;(gExploitChainTraceList&nbsp;1&nbsp;chain&nbsp;1).&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="person_1_initial_balance" class="idref" href="#person_1_initial_balance"><span class="id" title="definition">person_1_initial_balance</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Amount"><span class="id" title="definition">Amount</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#chain"><span class="id" title="definition">chain</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="exchange_liquidity" class="idref" href="#exchange_liquidity"><span class="id" title="definition">exchange_liquidity</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Amount"><span class="id" title="definition">Amount</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#chain"><span class="id" title="definition">chain</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;Helper&nbsp;function&nbsp;to&nbsp;retrieve&nbsp;an&nbsp;account's&nbsp;(exchange&nbsp;contract)&nbsp;token&nbsp;balance&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="account_tokens" class="idref" href="#account_tokens"><span class="id" title="definition">account_tokens</span></a> (<a id="env:21" class="idref" href="#env:21"><span class="id" title="binder">env</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Environment"><span class="id" title="record">Environment</span></a>) (<a id="account:22" class="idref" href="#account:22"><span class="id" title="binder">account</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a>) : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Numbers.BinNums.html#N"><span class="id" title="inductive">N</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0%<span class="id" title="var">N</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <a id="state_fa2:23" class="idref" href="#state_fa2:23"><span class="id" title="binder">state_fa2</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#token_state"><span class="id" title="definition">token_state</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#env:21"><span class="id" title="variable">env</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <a id="assets:24" class="idref" href="#assets:24"><span class="id" title="binder">assets</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_token_id"><span class="id" title="definition">exchange_token_id</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#state_fa2:23"><span class="id" title="variable">state_fa2</span></a>.(<a class="idref" href="ConCert.Examples.FA2.FA2Token.html#assets"><span class="id" title="projection">assets</span></a>) <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#account:22"><span class="id" title="variable">account</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#assets:24"><span class="id" title="variable">assets</span></a>.(<a class="idref" href="ConCert.Examples.FA2.FA2Token.html#balances"><span class="id" title="projection">balances</span></a>)).<br/>

<br/>
<span class="comment">(*&nbsp;Initially,&nbsp;the&nbsp;exchange&nbsp;contract&nbsp;has&nbsp;1000&nbsp;tokens,&nbsp;and&nbsp;so&nbsp;does&nbsp;person_1.<br/>
&nbsp;&nbsp;&nbsp;The&nbsp;exchange&nbsp;contract&nbsp;has&nbsp;30&nbsp;on-chain&nbsp;currency,&nbsp;and&nbsp;person_1&nbsp;has&nbsp;0&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(account_tokens&nbsp;chain&nbsp;exchange_caddr).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;1000*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(account_tokens&nbsp;chain&nbsp;person_1).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;1000*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;person_1_initial_balance.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;0*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;exchange_liquidity.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;30*)</span><br/>

<br/>
<span class="comment">(*&nbsp;---&nbsp;PATH-DEPENDENCE&nbsp;---<br/>
&nbsp;&nbsp;This&nbsp;property&nbsp;is&nbsp;a&nbsp;consequence&nbsp;of&nbsp;the&nbsp;*path-dependence*&nbsp;property,<br/>
&nbsp;&nbsp;and&nbsp;asserts&nbsp;that&nbsp;the&nbsp;token&nbsp;reserve&nbsp;of&nbsp;the&nbsp;exchange&nbsp;contract&nbsp;is&nbsp;consistent<br/>
&nbsp;&nbsp;with&nbsp;how&nbsp;much&nbsp;money&nbsp;has&nbsp;been&nbsp;exchanged&nbsp;for&nbsp;tokens,&nbsp;with&nbsp;respect&nbsp;to&nbsp;the&nbsp;conversion&nbsp;function&nbsp;'getInputPrice'.<br/>
&nbsp;&nbsp;"Consistency"&nbsp;in&nbsp;this&nbsp;case&nbsp;means&nbsp;that&nbsp;given&nbsp;a&nbsp;sequence&nbsp;of&nbsp;trades&nbsp;for&nbsp;some&nbsp;account,&nbsp;the&nbsp;total&nbsp;tokens&nbsp;obtained<br/>
&nbsp;&nbsp;by&nbsp;this&nbsp;sequence&nbsp;of&nbsp;trades&nbsp;should&nbsp;be&nbsp;less&nbsp;than&nbsp;if&nbsp;the&nbsp;trades&nbsp;were&nbsp;combined&nbsp;into&nbsp;a&nbsp;single&nbsp;trade,&nbsp;i.e.<br/>
&nbsp;&nbsp;*splitting&nbsp;trades&nbsp;should&nbsp;always&nbsp;be&nbsp;more&nbsp;expensive*<br/>
*)</span><br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">Z_scope</span>.<br/>
<span class="id" title="keyword">Definition</span> <a id="tokens_to_asset_correct_P_opt" class="idref" href="#tokens_to_asset_correct_P_opt"><span class="id" title="definition">tokens_to_asset_correct_P_opt</span></a> (<a id="old_env:25" class="idref" href="#old_env:25"><span class="id" title="binder">old_env</span></a> <a id="new_env:26" class="idref" href="#new_env:26"><span class="id" title="binder">new_env</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Environment"><span class="id" title="record">Environment</span></a>) : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <span class="id" title="definition">Checker</span> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">do</span></a> <a id="state_exchange:27" class="idref" href="#state_exchange:27"><span class="id" title="binder">state_exchange</span></a> <a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_state"><span class="id" title="definition">exchange_state</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#new_env:26"><span class="id" title="variable">new_env</span></a><a class="idref" href="ConCert.Execution.Monad.html#bbeef38f67325be53cb9324ba9182131"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="person_1_balance:28" class="idref" href="#person_1_balance:28"><span class="id" title="binder">person_1_balance</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#new_env:26"><span class="id" title="variable">new_env</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="exchange_balance:29" class="idref" href="#exchange_balance:29"><span class="id" title="binder">exchange_balance</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#new_env:26"><span class="id" title="variable">new_env</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="exchange_initial_balance:30" class="idref" href="#exchange_initial_balance:30"><span class="id" title="binder">exchange_initial_balance</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#old_env:25"><span class="id" title="variable">old_env</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="exchange_initial_token_reserve:31" class="idref" href="#exchange_initial_token_reserve:31"><span class="id" title="binder">exchange_initial_token_reserve</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">Z.of_N</span></a> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#account_tokens"><span class="id" title="definition">account_tokens</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#old_env:25"><span class="id" title="variable">old_env</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="exchange_current_token_reserve:32" class="idref" href="#exchange_current_token_reserve:32"><span class="id" title="binder">exchange_current_token_reserve</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">Z.of_N</span></a> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#account_tokens"><span class="id" title="definition">account_tokens</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#new_env:26"><span class="id" title="variable">new_env</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_caddr"><span class="id" title="definition">exchange_caddr</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;assume&nbsp;only&nbsp;the&nbsp;given&nbsp;account&nbsp;has&nbsp;made&nbsp;exchanges&nbsp;in&nbsp;this&nbsp;time&nbsp;period.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;assumption&nbsp;holds&nbsp;for&nbsp;these&nbsp;tests.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="tokens_received:33" class="idref" href="#tokens_received:33"><span class="id" title="binder">tokens_received</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_current_token_reserve:32"><span class="id" title="variable">exchange_current_token_reserve</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#::Z_scope:x_'-'_x"><span class="id" title="notation">-</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_initial_token_reserve:31"><span class="id" title="variable">exchange_initial_token_reserve</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Calculate&nbsp;token&nbsp;exchange&nbsp;price&nbsp;if&nbsp;only&nbsp;a&nbsp;single&nbsp;exchange&nbsp;was&nbsp;made&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="expected_currency_sold:34" class="idref" href="#expected_currency_sold:34"><span class="id" title="binder">expected_currency_sold</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#getInputPrice"><span class="id" title="definition">getInputPrice</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#tokens_received:33"><span class="id" title="variable">tokens_received</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_initial_token_reserve:31"><span class="id" title="variable">exchange_initial_token_reserve</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_initial_balance:30"><span class="id" title="variable">exchange_initial_balance</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="expected_exchange_balance:35" class="idref" href="#expected_exchange_balance:35"><span class="id" title="binder">expected_exchange_balance</span></a> := <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_initial_balance:30"><span class="id" title="variable">exchange_initial_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#::Z_scope:x_'-'_x"><span class="id" title="notation">-</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#expected_currency_sold:34"><span class="id" title="variable">expected_currency_sold</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"exchange balance was " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_balance:29"><span class="id" title="variable">exchange_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" while it was expected to be at least " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#expected_exchange_balance:35"><span class="id" title="variable">expected_exchange_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"person_1 balance: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#person_1_balance:28"><span class="id" title="variable">person_1_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"person_1 tokens: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#account_tokens"><span class="id" title="definition">account_tokens</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#new_env:26"><span class="id" title="variable">new_env</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"exchange balance: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_balance:29"><span class="id" title="variable">exchange_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"exchange tokens: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_current_token_reserve:32"><span class="id" title="variable">exchange_current_token_reserve</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"history: " <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#state_exchange:27"><span class="id" title="variable">state_exchange</span></a>.(<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggy.html#price_history"><span class="id" title="projection">price_history</span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#expected_exchange_balance:35"><span class="id" title="variable">expected_exchange_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#90a0b0fc12252358f48538aa18bc4b8e"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#exchange_balance:29"><span class="id" title="variable">exchange_balance</span></a>))<br/>
&nbsp;&nbsp;).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="tokens_to_asset_correct_P" class="idref" href="#tokens_to_asset_correct_P"><span class="id" title="definition">tokens_to_asset_correct_P</span></a> <a id="old_env:36" class="idref" href="#old_env:36"><span class="id" title="binder">old_env</span></a> <a id="new_env:37" class="idref" href="#new_env:37"><span class="id" title="binder">new_env</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#tokens_to_asset_correct_P_opt"><span class="id" title="definition">tokens_to_asset_correct_P_opt</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#old_env:36"><span class="id" title="variable">old_env</span></a> <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#new_env:37"><span class="id" title="variable">new_env</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">p</span> =&gt; <span class="id" title="var">p</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="tokens_to_asset_correct" class="idref" href="#tokens_to_asset_correct"><span class="id" title="definition">tokens_to_asset_correct</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TraceGens.html#forAllChainStatePairs"><span class="id" title="definition">TraceGens.forAllChainStatePairs</span></a> 1 <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#chain"><span class="id" title="definition">chain</span></a> (<a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#gExploitChainTraceList"><span class="id" title="definition">gExploitChainTraceList</span></a> 1) <a class="idref" href="ConCert.Examples.ExchangeBuggy.ExchangeBuggyTests.html#tokens_to_asset_correct_P"><span class="id" title="definition">tokens_to_asset_correct_P</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;Illustration&nbsp;of&nbsp;how&nbsp;the&nbsp;reentrancy&nbsp;attack&nbsp;can&nbsp;give&nbsp;the&nbsp;caller&nbsp;more&nbsp;money&nbsp;with&nbsp;the&nbsp;same&nbsp;amount&nbsp;of&nbsp;tokens.<br/>
&nbsp;&nbsp;&nbsp;Notice&nbsp;how&nbsp;in&nbsp;the&nbsp;second&nbsp;sequence,&nbsp;the&nbsp;second&nbsp;argument&nbsp;remains&nbsp;the&nbsp;same,&nbsp;ie.&nbsp;it&nbsp;emulates&nbsp;the&nbsp;reentrancy&nbsp;attack.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1000&nbsp;30).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;4&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1200&nbsp;26).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;3&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1400&nbsp;23).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;2&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1600&nbsp;21).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;2&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1800&nbsp;19).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;1&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;total&nbsp;=&nbsp;12&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1000&nbsp;30).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;4&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1000&nbsp;26).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;4&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1000&nbsp;22).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;3&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1000&nbsp;19).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;3&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Compute&nbsp;(getInputPrice&nbsp;200&nbsp;1000&nbsp;16).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;2&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;total&nbsp;=&nbsp;16&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(expectFailure&nbsp;tokens_to_asset_correct).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
Begin&nbsp;Trace:<br/>
step_action{Action{act_from:&nbsp;11256,&nbsp;0,&nbsp;transferhook&nbsp;transfer_descriptor_param{transfer_descr_fa2:&nbsp;128256})}}<br/>
End&nbsp;Trace<br/>
exchange&nbsp;balance&nbsp;was&nbsp;14&nbsp;while&nbsp;it&nbsp;was&nbsp;expected&nbsp;to&nbsp;be&nbsp;at&nbsp;least&nbsp;16person_1&nbsp;balance:&nbsp;16<br/>
person_1&nbsp;tokens:&nbsp;0<br/>
exchange&nbsp;balance:&nbsp;14<br/>
exchange&nbsp;tokens:&nbsp;2000<br/>
history:&nbsp;<span class="inlinecode">2;</span> <span class="inlinecode">3;</span> <span class="inlinecode">3;</span> <span class="inlinecode">4;</span> <span class="inlinecode">4</span><br/>
***&nbsp;Failed&nbsp;after&nbsp;1&nbsp;tests&nbsp;and&nbsp;0&nbsp;shrinks.&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>
</div>
</div>
<div id="footer">
  Generated by <a href="https://coq.inria.fr/">coqdoc</a> and improved with <a href="https://github.com/tebbi/coqdocjs">CoqdocJS</a> and <a href="https://github.com/jgallen23/toc">TOC</a>
</div>
</div>
<script>
  const elements = document.getElementsByClassName("libtitle");
  while(elements.length > 0){
        elements[0].parentNode.removeChild(elements[0]);
  }
  if (window.location.pathname.endsWith("/toc.html")) {
      const jstocDiv = document.getElementById("js-toc");
      jstocDiv.classList.remove("toc");
      jstocDiv.classList.add("jstoc-hidden");
      const jstocHeaderDiv = document.getElementById("js-toc-header");
      jstocHeaderDiv.classList.add("jstoc-hidden");
      const mainDiv = document.getElementById("main");
      mainDiv.classList.add("jstoc-hidden-main");
      const toggleDiv = document.getElementById("toggle-toc");
      toggleDiv.classList.add("jstoc-hidden");
  }
  console.log(window.location.pathname);
</script>
<script type="text/javascript" src="toc.js"></script>
</body>

</html>
