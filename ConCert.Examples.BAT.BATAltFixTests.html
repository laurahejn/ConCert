<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<link href="coqdocjs.css" rel="stylesheet" type="text/css"/>
<link href="toc.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="coqdocjs.js"></script>
</head>

<body onload="document.getElementById('content').focus()">
  <div id="header">
    <span class="left">
      <span class="modulename"> <script> document.write(document.title) </script> </span>
      <span id="toggle-toc">Contents</span>
    </span>

    <span class="button" id="toggle-proofs"></span>

    <span class="right">
      <a href="https://github.com/AU-COBRA/ConCert" target="_balnk">Project Page</a>
      <a href="index.html">Index</a>
      <a href="toc.html">Table of contents</a>
    </span>
</div>
  <div id="content" tabindex="-1" onblur="document.getElementById('content').focus()">
    <div id="js-toc" class="toc" data-toc="h1,h2,h3,h4" data-toc-container="doc" data-toc-offset="-40">
      <div id="js-toc-header" class="toc-header">Contents:</div>
    </div>
    <div id="main">
<h1 class="libtitle">Library ConCert.Examples.BAT.BATAltFixTests</h1>

<div class="code">
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Utils.Extras.html#"><span class="id" title="library">Extras</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Blockchain.html#"><span class="id" title="library">Blockchain</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.BoundedN.html#"><span class="id" title="library">BoundedN</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Containers.html#"><span class="id" title="library">Containers</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Serializable.html#"><span class="id" title="library">Serializable</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution.Test</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Execution.Test.QCTest.html#"><span class="id" title="library">QCTest</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#"><span class="id" title="library">BATCommon</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFix.html#"><span class="id" title="library">BATAltFix</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.BAT.BATGens.html#"><span class="id" title="library">BATGens</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Export</span> <a class="idref" href="ConCert.Examples.BAT.BATPrinters.html#"><span class="id" title="library">BATPrinters</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.BAT</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#"><span class="id" title="library">BATTestCommon</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#"><span class="id" title="library">List</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.ZArith_base.html#"><span class="id" title="library">ZArith_base</span></a>.<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ListNotations"><span class="id" title="module">ListNotations</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;--------------------------&nbsp;Tests&nbsp;of&nbsp;the&nbsp;BAT&nbsp;Implementation&nbsp;--------------------------&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="fundingStart_" class="idref" href="#fundingStart_"><span class="id" title="definition">fundingStart_</span></a> := 1.<br/>
<span class="id" title="keyword">Definition</span> <a id="fundingEnd_" class="idref" href="#fundingEnd_"><span class="id" title="definition">fundingEnd_</span></a> := 4.<br/>
<span class="id" title="keyword">Definition</span> <a id="tokenCap_" class="idref" href="#tokenCap_"><span class="id" title="definition">tokenCap_</span></a> := 81%<span class="id" title="var">N</span>.<br/>
<span class="id" title="keyword">Definition</span> <a id="tokenMin_" class="idref" href="#tokenMin_"><span class="id" title="definition">tokenMin_</span></a> := 43%<span class="id" title="var">N</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="bat_setup" class="idref" href="#bat_setup"><span class="id" title="definition">bat_setup</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#build_setup"><span class="id" title="constructor">BATCommon.build_setup</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#initSupply_"><span class="id" title="definition">initSupply_</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#ethFund"><span class="id" title="definition">ethFund</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#batFund"><span class="id" title="definition">batFund</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fundingStart_"><span class="id" title="definition">fundingStart_</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fundingEnd_"><span class="id" title="definition">fundingEnd_</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#exchangeRate_"><span class="id" title="definition">exchangeRate_</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#tokenCap_"><span class="id" title="definition">tokenCap_</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#tokenMin_"><span class="id" title="definition">tokenMin_</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;In&nbsp;the&nbsp;initial&nbsp;chain&nbsp;we&nbsp;transfer&nbsp;some&nbsp;assets&nbsp;to&nbsp;a&nbsp;few&nbsp;accounts,&nbsp;just&nbsp;to&nbsp;make&nbsp;the&nbsp;addresses<br/>
&nbsp;&nbsp;&nbsp;present&nbsp;in&nbsp;the&nbsp;chain&nbsp;state.&nbsp;The&nbsp;amount&nbsp;transferred&nbsp;is&nbsp;irrelevant.&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="token_cb" class="idref" href="#token_cb"><span class="id" title="definition">token_cb</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#unpack_result"><span class="id" title="definition">ResultMonad.unpack_result</span></a> (<a class="idref" href="ConCert.Execution.Test.TraceGens.html#add_block"><span class="id" title="definition">TraceGens.add_block</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#empty_chain"><span class="id" title="definition">empty_chain</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> 10<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_2"><span class="id" title="definition">person_2</span></a> 7<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_3"><span class="id" title="definition">person_3</span></a> 6<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_4"><span class="id" title="definition">person_4</span></a> 10<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#ethFund"><span class="id" title="definition">ethFund</span></a> 2<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#batFund"><span class="id" title="definition">batFund</span></a> 2<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_deploy"><span class="id" title="definition">build_deploy</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> 0 <a class="idref" href="ConCert.Examples.BAT.BATAltFix.html#contract"><span class="id" title="definition">BATAltFix.contract</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#bat_setup"><span class="id" title="definition">bat_setup</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>).<br/>

<br/>
<span class="id" title="keyword">Module</span> <a id="TestInfo" class="idref" href="#TestInfo"><span class="id" title="module">TestInfo</span></a> &lt;: <a class="idref" href="ConCert.Examples.BAT.BATGens.html#BATGensInfo"><span class="id" title="module">BATGensInfo</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.contract_addr" class="idref" href="#TestInfo.contract_addr"><span class="id" title="definition">contract_addr</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.accounts" class="idref" href="#TestInfo.accounts"><span class="id" title="definition">accounts</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#batFund"><span class="id" title="definition">batFund</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#ethFund"><span class="id" title="definition">ethFund</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#bc347c51eaf667706ae54503b26d52c6"><span class="id" title="notation">++</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#test_chain_addrs_5"><span class="id" title="definition">test_chain_addrs_5</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.gAccount" class="idref" href="#TestInfo.gAccount"><span class="id" title="definition">gAccount</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#gAddress"><span class="id" title="definition">gAddress</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#TestInfo.accounts"><span class="id" title="definition">accounts</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.bat_addr" class="idref" href="#TestInfo.bat_addr"><span class="id" title="definition">bat_addr</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#batFund"><span class="id" title="definition">batFund</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.fund_addr" class="idref" href="#TestInfo.fund_addr"><span class="id" title="definition">fund_addr</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#ethFund"><span class="id" title="definition">ethFund</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.accounts_total_balance" class="idref" href="#TestInfo.accounts_total_balance"><span class="id" title="definition">accounts_total_balance</span></a> := 37%<span class="id" title="var">Z</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.trace_length" class="idref" href="#TestInfo.trace_length"><span class="id" title="definition">trace_length</span></a> := 7.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.bat_addr_refundable" class="idref" href="#TestInfo.bat_addr_refundable"><span class="id" title="definition">bat_addr_refundable</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.bat_addr_fundable" class="idref" href="#TestInfo.bat_addr_fundable"><span class="id" title="definition">bat_addr_fundable</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="TestInfo.eip20_transactions_before_finalized" class="idref" href="#TestInfo.eip20_transactions_before_finalized"><span class="id" title="definition">eip20_transactions_before_finalized</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a>.<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#TestInfo"><span class="id" title="module">TestInfo</span></a>.<br/>
<span class="id" title="keyword">Module</span> <a id="MG" class="idref" href="#MG"><span class="id" title="module">MG</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATGens.html#BATGens"><span class="id" title="module">BATGens</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#TestInfo"><span class="id" title="module">TestInfo</span></a>. <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#MG"><span class="id" title="module">MG</span></a>.<br/>

<br/>
<span class="id" title="keyword">Module</span> <a id="NotationInfo" class="idref" href="#NotationInfo"><span class="id" title="module">NotationInfo</span></a> &lt;: <a class="idref" href="ConCert.Execution.Test.TestNotation.html#TestNotationParameters"><span class="id" title="module">TestNotationParameters</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="NotationInfo.gAction" class="idref" href="#NotationInfo.gAction"><span class="id" title="definition">gAction</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#MG.gBATAction"><span class="id" title="definition">gBATAction</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="NotationInfo.init_cb" class="idref" href="#NotationInfo.init_cb"><span class="id" title="definition">init_cb</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#token_cb"><span class="id" title="definition">token_cb</span></a>.<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#NotationInfo"><span class="id" title="module">NotationInfo</span></a>.<br/>
<span class="id" title="keyword">Module</span> <a id="TN" class="idref" href="#TN"><span class="id" title="module">TN</span></a> := <a class="idref" href="ConCert.Execution.Test.TestNotation.html#TestNotations"><span class="id" title="module">TestNotations</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#NotationInfo"><span class="id" title="module">NotationInfo</span></a>. <span class="id" title="keyword">Import</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#TN"><span class="id" title="module">TN</span></a>.<br/>

<br/>
<span class="comment">(*&nbsp;Test&nbsp;generators&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Sample&nbsp;generator&nbsp;to&nbsp;see&nbsp;quality&nbsp;of&nbsp;generated&nbsp;chains&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Sample&nbsp;(gChain).&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Unless&nbsp;something&nbsp;is&nbsp;wrong&nbsp;witht&nbsp;he&nbsp;contract&nbsp;it&nbsp;should&nbsp;be<br/>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;case&nbsp;that&nbsp;gBATActionValid&nbsp;only&nbsp;produces&nbsp;valid&nbsp;actions&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(forAll&nbsp;(gInvalidActions&nbsp;gBATActionValid)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;x&nbsp;=&gt;&nbsp;collect&nbsp;(snd&nbsp;x)&nbsp;true)).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
8970&nbsp;:<br/>
20&nbsp;:&nbsp;Action{act_from:&nbsp;_,&nbsp;act_body:&nbsp;(act_call&nbsp;128256,&nbsp;0,&nbsp;transfer_from&nbsp;_&nbsp;_&nbsp;0)}<br/>
+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>
<span class="comment">(*<br/>
&nbsp;&nbsp;We&nbsp;see&nbsp;that&nbsp;the&nbsp;only&nbsp;failed&nbsp;requests&nbsp;are&nbsp;transfers&nbsp;of&nbsp;0&nbsp;from&nbsp;accounts&nbsp;that&nbsp;are<br/>
&nbsp;&nbsp;not&nbsp;in&nbsp;the&nbsp;contract&nbsp;state.&nbsp;This&nbsp;is&nbsp;because&nbsp;the&nbsp;EIP20&nbsp;generator&nbsp;will&nbsp;generate<br/>
&nbsp;&nbsp;transfers&nbsp;of&nbsp;0&nbsp;between&nbsp;random&nbsp;addresses&nbsp;when&nbsp;there&nbsp;are&nbsp;no&nbsp;addresses&nbsp;in&nbsp;the<br/>
&nbsp;&nbsp;contract&nbsp;state.&nbsp;These&nbsp;shouldn't&nbsp;fail&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;seems&nbsp;relate&nbsp;to&nbsp;BAT.<br/>
*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Verify&nbsp;hardness&nbsp;of&nbsp;finalizing&nbsp;BAToken.<br/>
&nbsp;&nbsp;&nbsp;Goal&nbsp;is&nbsp;~&nbsp;2/3&nbsp;of&nbsp;generated&nbsp;chains&nbsp;are&nbsp;finalized&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(forAllChainBuilders&nbsp;(fun&nbsp;cb&nbsp;=&gt;&nbsp;collect&nbsp;(get_chain_finalized&nbsp;cb)&nbsp;true)).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
&nbsp;&nbsp;6979&nbsp;:&nbsp;true<br/>
&nbsp;&nbsp;3021&nbsp;:&nbsp;false<br/>
&nbsp;&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Check&nbsp;heigh&nbsp;chains&nbsp;produced&nbsp;by&nbsp;the&nbsp;chain&nbsp;generator<br/>
&nbsp;&nbsp;&nbsp;We&nbsp;want&nbsp;the&nbsp;average&nbsp;chain&nbsp;height&nbsp;to&nbsp;be&nbsp;close&nbsp;to&nbsp;full&nbsp;length<br/>
&nbsp;&nbsp;&nbsp;since&nbsp;this&nbsp;is&nbsp;a&nbsp;sign&nbsp;that&nbsp;the&nbsp;generator&nbsp;does&nbsp;not&nbsp;generate<br/>
&nbsp;&nbsp;&nbsp;invalid&nbsp;requests&nbsp;so&nbsp;often&nbsp;that&nbsp;it&nbsp;affects&nbsp;chain&nbsp;quality&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(forAllChainBuilders&nbsp;(fun&nbsp;cb&nbsp;=&gt;&nbsp;collect&nbsp;(get_chain_height&nbsp;cb)&nbsp;true)).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
&nbsp;&nbsp;9820&nbsp;:&nbsp;9<br/>
&nbsp;&nbsp;53&nbsp;:&nbsp;6<br/>
&nbsp;&nbsp;42&nbsp;:&nbsp;7<br/>
&nbsp;&nbsp;35&nbsp;:&nbsp;8<br/>
&nbsp;&nbsp;32&nbsp;:&nbsp;5<br/>
&nbsp;&nbsp;11&nbsp;:&nbsp;1<br/>
&nbsp;&nbsp;6&nbsp;:&nbsp;4<br/>
&nbsp;&nbsp;1&nbsp;:&nbsp;3<br/>
&nbsp;&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Verify&nbsp;spread&nbsp;of&nbsp;tokens&nbsp;after&nbsp;funding&nbsp;period&nbsp;is&nbsp;over.<br/>
&nbsp;&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;to&nbsp;see&nbsp;it&nbsp;it&nbsp;possible&nbsp;to&nbsp;hit&nbsp;the&nbsp;funding&nbsp;cap<br/>
&nbsp;&nbsp;&nbsp;and&nbsp;how&nbsp;easy&nbsp;it&nbsp;is&nbsp;to&nbsp;do.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(forAllChainBuilders&nbsp;(fun&nbsp;cb&nbsp;=&gt;&nbsp;collect&nbsp;(get_chain_tokens&nbsp;cb)&nbsp;true)).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
&nbsp;&nbsp;672&nbsp;:&nbsp;48<br/>
&nbsp;&nbsp;662&nbsp;:&nbsp;54<br/>
&nbsp;&nbsp;654&nbsp;:&nbsp;45<br/>
&nbsp;&nbsp;648&nbsp;:&nbsp;57<br/>
&nbsp;&nbsp;636&nbsp;:&nbsp;51<br/>
&nbsp;&nbsp;591&nbsp;:&nbsp;63<br/>
&nbsp;&nbsp;573&nbsp;:&nbsp;42<br/>
&nbsp;&nbsp;572&nbsp;:&nbsp;60<br/>
&nbsp;&nbsp;551&nbsp;:&nbsp;66<br/>
&nbsp;&nbsp;513&nbsp;:&nbsp;69<br/>
&nbsp;&nbsp;485&nbsp;:&nbsp;39<br/>
&nbsp;&nbsp;433&nbsp;:&nbsp;36<br/>
&nbsp;&nbsp;420&nbsp;:&nbsp;72<br/>
&nbsp;&nbsp;375&nbsp;:&nbsp;33<br/>
&nbsp;&nbsp;343&nbsp;:&nbsp;75<br/>
&nbsp;&nbsp;341&nbsp;:&nbsp;78<br/>
&nbsp;&nbsp;312&nbsp;:&nbsp;30<br/>
&nbsp;&nbsp;296&nbsp;:&nbsp;81<br/>
&nbsp;&nbsp;270&nbsp;:&nbsp;27<br/>
&nbsp;&nbsp;211&nbsp;:&nbsp;24<br/>
&nbsp;&nbsp;119&nbsp;:&nbsp;21<br/>
&nbsp;&nbsp;102&nbsp;:&nbsp;18<br/>
&nbsp;&nbsp;75&nbsp;:&nbsp;0<br/>
&nbsp;&nbsp;70&nbsp;:&nbsp;15<br/>
&nbsp;&nbsp;37&nbsp;:&nbsp;12<br/>
&nbsp;&nbsp;31&nbsp;:&nbsp;9<br/>
&nbsp;&nbsp;5&nbsp;:&nbsp;6<br/>
&nbsp;&nbsp;3&nbsp;:&nbsp;3<br/>
&nbsp;&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="id" title="keyword">Local Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">N_scope</span>.<br/>
<span class="comment">(*&nbsp;Only&nbsp;create_tokens&nbsp;should&nbsp;be&nbsp;payable&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{fun&nbsp;state&nbsp;msg&nbsp;=&gt;&nbsp;negb&nbsp;(msg_is_create_tokens&nbsp;state&nbsp;msg)}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{amount_is_zero}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;only&nbsp;accept&nbsp;calls&nbsp;with&nbsp;money&nbsp;in&nbsp;them&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{msg_is_create_tokens}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{amount_is_positive}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;EIP&nbsp;messages&nbsp;and&nbsp;create_tokens&nbsp;should&nbsp;not&nbsp;produce&nbsp;any&nbsp;actions&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{msg_is_eip_msg&nbsp;|||&nbsp;msg_is_create_tokens}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{produces_no_actions}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;refund&nbsp;and&nbsp;finalize&nbsp;should&nbsp;produce&nbsp;an&nbsp;actions&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{msg_is_refund&nbsp;|||&nbsp;msg_is_finalize}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{produces_one_action}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Chcker&nbsp;failing&nbsp;if&nbsp;any&nbsp;constants&nbsp;in&nbsp;BAT&nbsp;states&nbsp;are&nbsp;changed&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="constants_unchanged" class="idref" href="#constants_unchanged"><span class="id" title="definition">constants_unchanged</span></a> (<a id="chain:1" class="idref" href="#chain:1"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:2" class="idref" href="#cctx:2"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:3" class="idref" href="#old_state:3"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:4" class="idref" href="#msg:4"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:5" class="idref" href="#result_opt:5"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:5"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:4"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;batFund&nbsp;and&nbsp;ethFund&nbsp;addresses&nbsp;should&nbsp;be&nbsp;constants&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="fund_deposit_check:6" class="idref" href="#fund_deposit_check:6"><span class="id" title="binder">fund_deposit_check</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:3"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundDeposit"><span class="id" title="projection">fundDeposit</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundDeposit"><span class="id" title="projection">fundDeposit</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="bat_deposit_check:7" class="idref" href="#bat_deposit_check:7"><span class="id" title="binder">bat_deposit_check</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:3"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#batFundDeposit"><span class="id" title="projection">batFundDeposit</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#batFundDeposit"><span class="id" title="projection">batFundDeposit</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Funding&nbsp;start&nbsp;block&nbsp;and&nbsp;end&nbsp;block&nbsp;should&nbsp;be&nbsp;constants&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="funding_start_check:8" class="idref" href="#funding_start_check:8"><span class="id" title="binder">funding_start_check</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#Nat.eqb"><span class="id" title="definition">Nat.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:3"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingStart"><span class="id" title="projection">fundingStart</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingStart"><span class="id" title="projection">fundingStart</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="funding_end_check:9" class="idref" href="#funding_end_check:9"><span class="id" title="binder">funding_end_check</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#Nat.eqb"><span class="id" title="definition">Nat.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:3"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingEnd"><span class="id" title="projection">fundingEnd</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingEnd"><span class="id" title="projection">fundingEnd</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Token&nbsp;exchange&nbsp;rate&nbsp;and&nbsp;initSupply&nbsp;should&nbsp;be&nbsp;constants&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="exchange_rate_check:10" class="idref" href="#exchange_rate_check:10"><span class="id" title="binder">exchange_rate_check</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:3"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="init_supply_check:11" class="idref" href="#init_supply_check:11"><span class="id" title="binder">init_supply_check</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:3"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#initSupply"><span class="id" title="projection">initSupply</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#initSupply"><span class="id" title="projection">initSupply</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Minimum&nbsp;and&nbsp;maximum&nbsp;token&nbsp;limits&nbsp;should&nbsp;be&nbsp;constants&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="creation_cap_check:12" class="idref" href="#creation_cap_check:12"><span class="id" title="binder">creation_cap_check</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:3"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationCap"><span class="id" title="projection">tokenCreationCap</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationCap"><span class="id" title="projection">tokenCreationCap</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="creation_min_check:13" class="idref" href="#creation_min_check:13"><span class="id" title="binder">creation_min_check</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:3"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationMin"><span class="id" title="projection">tokenCreationMin</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationMin"><span class="id" title="projection">tokenCreationMin</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fund_deposit_check:6"><span class="id" title="variable">fund_deposit_check</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#bat_deposit_check:7"><span class="id" title="variable">bat_deposit_check</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#funding_start_check:8"><span class="id" title="variable">funding_start_check</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#funding_end_check:9"><span class="id" title="variable">funding_end_check</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#exchange_rate_check:10"><span class="id" title="variable">exchange_rate_check</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#init_supply_check:11"><span class="id" title="variable">init_supply_check</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#creation_cap_check:12"><span class="id" title="variable">creation_cap_check</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#creation_min_check:13"><span class="id" title="variable">creation_min_check</span></a>)<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;No&nbsp;contract&nbsp;calls&nbsp;modify&nbsp;constants&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(<br/>
&nbsp;&nbsp;{{fun&nbsp;state&nbsp;msg&nbsp;=&gt;&nbsp;true}}<br/>
&nbsp;&nbsp;contract_base_addr<br/>
&nbsp;&nbsp;{{constants_unchanged}}<br/>
).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;create_tokens&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="post_create_tokens_update_correct" class="idref" href="#post_create_tokens_update_correct"><span class="id" title="definition">post_create_tokens_update_correct</span></a> (<a id="chain:14" class="idref" href="#chain:14"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:15" class="idref" href="#cctx:15"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="old_state:16" class="idref" href="#old_state:16"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>) (<a id="msg:17" class="idref" href="#msg:17"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="result_opt:18" class="idref" href="#result_opt:18"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:18"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:17"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#create_tokens"><span class="id" title="constructor">create_tokens</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount:19" class="idref" href="#amount:19"><span class="id" title="binder">amount</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:15"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_amount"><span class="id" title="projection">ctx_amount</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:20" class="idref" href="#from:20"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:15"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;token&nbsp;balance&nbsp;of&nbsp;from&nbsp;should&nbsp;be&nbsp;increased&nbsp;by&nbsp;amount&nbsp;*&nbsp;exchangerate&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="balance_correct:21" class="idref" href="#balance_correct:21"><span class="id" title="binder">balance_correct</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#get_balance"><span class="id" title="definition">get_balance</span></a> <span class="id" title="var">new_state</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:20"><span class="id" title="variable">from</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#get_balance"><span class="id" title="definition">get_balance</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:16"><span class="id" title="variable">old_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:20"><span class="id" title="variable">from</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.to_N"><span class="id" title="definition">Z.to_N</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount:19"><span class="id" title="variable">amount</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#fe1417cc32a1703619b26940ce957c6a"><span class="id" title="notation">*</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:16"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;total&nbsp;supply&nbsp;field&nbsp;should&nbsp;be&nbsp;increased&nbsp;by&nbsp;amount&nbsp;*&nbsp;exchangerate&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="total_supply_correct:22" class="idref" href="#total_supply_correct:22"><span class="id" title="binder">total_supply_correct</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">new_state</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:16"><span class="id" title="variable">old_state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.to_N"><span class="id" title="definition">Z.to_N</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount:19"><span class="id" title="variable">amount</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#fe1417cc32a1703619b26940ce957c6a"><span class="id" title="notation">*</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:16"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:16"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:18"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#balance_correct:21"><span class="id" title="variable">balance_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#total_supply_correct:22"><span class="id" title="variable">total_supply_correct</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;create_tokens<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Create_tokens&nbsp;updates&nbsp;output&nbsp;correct&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_create_tokens}}&nbsp;contract_base_addr&nbsp;{{post_create_tokens_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="create_tokens_valid" class="idref" href="#create_tokens_valid"><span class="id" title="definition">create_tokens_valid</span></a> (<a id="chain:23" class="idref" href="#chain:23"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:24" class="idref" href="#cctx:24"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:25" class="idref" href="#old_state:25"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:26" class="idref" href="#msg:26"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:27" class="idref" href="#result_opt:27"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:27"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:26"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#create_tokens"><span class="id" title="constructor">create_tokens</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount:28" class="idref" href="#amount:28"><span class="id" title="binder">amount</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:24"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_amount"><span class="id" title="projection">ctx_amount</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="current_slot:29" class="idref" href="#current_slot:29"><span class="id" title="binder">current_slot</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#chain:23"><span class="id" title="variable">chain</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#current_slot"><span class="id" title="projection">current_slot</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;only&nbsp;return&nbsp;some&nbsp;if&nbsp;amount&nbsp;is&nbsp;larger&nbsp;than&nbsp;zero&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount_valid:30" class="idref" href="#amount_valid:30"><span class="id" title="binder">amount_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.leb"><span class="id" title="definition">Z.leb</span></a> 0 <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount:28"><span class="id" title="variable">amount</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;be&nbsp;callable&nbsp;if&nbsp;the&nbsp;token&nbsp;is&nbsp;not&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized_valid:31" class="idref" href="#is_finalized_valid:31"><span class="id" title="binder">is_finalized_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:25"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;be&nbsp;callable&nbsp;if&nbsp;the&nbsp;current&nbsp;slot&nbsp;is&nbsp;in&nbsp;the&nbsp;funding&nbsp;period&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="slot_valid:32" class="idref" href="#slot_valid:32"><span class="id" title="binder">slot_valid</span></a> := (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:25"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingStart"><span class="id" title="projection">fundingStart</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#0f31f5c1c6b6a21a3a187247222bc9e4"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#current_slot:29"><span class="id" title="variable">current_slot</span></a>)%<span class="id" title="var">nat</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#current_slot:29"><span class="id" title="variable">current_slot</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#0f31f5c1c6b6a21a3a187247222bc9e4"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:25"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingEnd"><span class="id" title="projection">fundingEnd</span></a>))%<span class="id" title="var">nat</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;be&nbsp;callable&nbsp;with&nbsp;an&nbsp;amount&nbsp;that&nbsp;does&nbsp;not&nbsp;cause<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;total_supply&nbsp;to&nbsp;go&nbsp;over&nbsp;the&nbsp;max&nbsp;tokens&nbsp;cap&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="new_token_amount_valid:33" class="idref" href="#new_token_amount_valid:33"><span class="id" title="binder">new_token_amount_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:25"><span class="id" title="variable">old_state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.to_N"><span class="id" title="definition">Z.to_N</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount:28"><span class="id" title="variable">amount</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#fe1417cc32a1703619b26940ce957c6a"><span class="id" title="notation">*</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:25"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:25"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationCap"><span class="id" title="projection">tokenCreationCap</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:25"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:27"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount_valid:30"><span class="id" title="variable">amount_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized_valid:31"><span class="id" title="variable">is_finalized_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#slot_valid:32"><span class="id" title="variable">slot_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#new_token_amount_valid:33"><span class="id" title="variable">new_token_amount_valid</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;create_tokens<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Create_tokens&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_create_tokens}}&nbsp;contract_base_addr&nbsp;{{create_tokens_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="post_create_tokens_safe" class="idref" href="#post_create_tokens_safe"><span class="id" title="definition">post_create_tokens_safe</span></a> (<a id="chain:34" class="idref" href="#chain:34"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:35" class="idref" href="#cctx:35"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:36" class="idref" href="#old_state:36"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:37" class="idref" href="#msg:37"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:38" class="idref" href="#result_opt:38"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:38"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:37"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#create_tokens"><span class="id" title="constructor">create_tokens</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:39" class="idref" href="#from:39"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:35"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;not&nbsp;change&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;token&nbsp;is&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized_unchanged:40" class="idref" href="#is_finalized_unchanged:40"><span class="id" title="binder">is_finalized_unchanged</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Bool.Bool.html#eqb"><span class="id" title="definition">Bool.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:36"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;should&nbsp;not&nbsp;change&nbsp;the&nbsp;allowances&nbsp;of&nbsp;any&nbsp;accounts&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="allowances_unchanged:43" class="idref" href="#allowances_unchanged:43"><span class="id" title="binder">allowances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> (<span class="id" title="keyword">fun</span> <a id="fmap:41" class="idref" href="#fmap:41"><span class="id" title="binder">fmap</span></a> <a id="fmap':42" class="idref" href="#fmap':42"><span class="id" title="binder">fmap'</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap:41"><span class="id" title="variable">fmap</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap':42"><span class="id" title="variable">fmap'</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:36"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create_tokens&nbsp;must&nbsp;only&nbsp;change&nbsp;the&nbsp;balance&nbsp;of&nbsp;the&nbsp;sender&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="other_balances_unchanged:44" class="idref" href="#other_balances_unchanged:44"><span class="id" title="binder">other_balances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_filter_eqb"><span class="id" title="definition">fmap_filter_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:39"><span class="id" title="variable">from</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:36"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:36"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:38"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized_unchanged:40"><span class="id" title="variable">is_finalized_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#allowances_unchanged:43"><span class="id" title="variable">allowances_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#other_balances_unchanged:44"><span class="id" title="variable">other_balances_unchanged</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;create_tokens<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Create_tokens&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_create_tokens}}&nbsp;contract_base_addr&nbsp;{{post_create_tokens_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;finalize&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="post_finalize_update_correct" class="idref" href="#post_finalize_update_correct"><span class="id" title="definition">post_finalize_update_correct</span></a> (<a id="chain:45" class="idref" href="#chain:45"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:46" class="idref" href="#cctx:46"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:47" class="idref" href="#old_state:47"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:48" class="idref" href="#msg:48"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:49" class="idref" href="#result_opt:49"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:49"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:48"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;finalize&nbsp;should&nbsp;produce&nbsp;a&nbsp;transfer&nbsp;action&nbsp;*)</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Execution.Blockchain.html#act_transfer"><span class="id" title="constructor">Blockchain.act_transfer</span></a> <span class="id" title="var">to</span> <span class="id" title="var">amount</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#finalize"><span class="id" title="constructor">finalize</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="contract_balance:50" class="idref" href="#contract_balance:50"><span class="id" title="binder">contract_balance</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:46"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_contract_balance"><span class="id" title="projection">ctx_contract_balance</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;If&nbsp;finalize&nbsp;returns&nbsp;some&nbsp;then&nbsp;if&nbsp;the&nbsp;token&nbsp;should&nbsp;be&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized_correct:51" class="idref" href="#is_finalized_correct:51"><span class="id" title="binder">is_finalized_correct</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Bool.Bool.html#eqb"><span class="id" title="definition">Bool.eqb</span></a> <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;transfer&nbsp;action&nbsp;produced&nbsp;should&nbsp;transfer&nbsp;to&nbsp;the&nbsp;ethFund&nbsp;address&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="action_to_correct:52" class="idref" href="#action_to_correct:52"><span class="id" title="binder">action_to_correct</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <span class="id" title="var">to</span> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#ethFund"><span class="id" title="definition">ethFund</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;transfer&nbsp;action&nbsp;produced&nbsp;should&nbsp;transfer&nbsp;the&nbsp;entire&nbsp;contract&nbsp;balance&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="action_amount_correct:53" class="idref" href="#action_amount_correct:53"><span class="id" title="binder">action_amount_correct</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.eqb"><span class="id" title="definition">Z.eqb</span></a> <span class="id" title="var">amount</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#contract_balance:50"><span class="id" title="variable">contract_balance</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="action_to_valid:54" class="idref" href="#action_to_valid:54"><span class="id" title="binder">action_to_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> (<a class="idref" href="ConCert.Execution.Blockchain.html#address_is_contract"><span class="id" title="method">address_is_contract</span></a> <span class="id" title="var">to</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="action_amount_valid:55" class="idref" href="#action_amount_valid:55"><span class="id" title="binder">action_amount_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.leb"><span class="id" title="definition">Z.leb</span></a> <span class="id" title="var">amount</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#contract_balance:50"><span class="id" title="variable">contract_balance</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;token&nbsp;balance&nbsp;of&nbsp;batFund&nbsp;should&nbsp;be&nbsp;increased&nbsp;by&nbsp;initSupply&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="balance_correct:56" class="idref" href="#balance_correct:56"><span class="id" title="binder">balance_correct</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#get_balance"><span class="id" title="definition">get_balance</span></a> <span class="id" title="var">new_state</span> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#batFund"><span class="id" title="definition">batFund</span></a>) (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#get_balance"><span class="id" title="definition">get_balance</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:47"><span class="id" title="variable">old_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#batFund"><span class="id" title="definition">batFund</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#initSupply"><span class="id" title="projection">initSupply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:47"><span class="id" title="variable">old_state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;total&nbsp;supply&nbsp;field&nbsp;should&nbsp;be&nbsp;increased&nbsp;by&nbsp;initSupply&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="total_supply_correct:57" class="idref" href="#total_supply_correct:57"><span class="id" title="binder">total_supply_correct</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">new_state</span>) (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:47"><span class="id" title="variable">old_state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#initSupply"><span class="id" title="projection">initSupply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:47"><span class="id" title="variable">old_state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:47"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:49"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized_correct:51"><span class="id" title="variable">is_finalized_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action_to_correct:52"><span class="id" title="variable">action_to_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action_amount_correct:53"><span class="id" title="variable">action_amount_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action_to_valid:54"><span class="id" title="variable">action_to_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action_amount_valid:55"><span class="id" title="variable">action_amount_valid</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;finalize<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Finalize&nbsp;updates&nbsp;state&nbsp;correct&nbsp;and&nbsp;produces&nbsp;correct&nbsp;actions&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_finalize}}&nbsp;contract_base_addr&nbsp;{{post_finalize_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="finalize_valid" class="idref" href="#finalize_valid"><span class="id" title="definition">finalize_valid</span></a> (<a id="chain:58" class="idref" href="#chain:58"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:59" class="idref" href="#cctx:59"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:60" class="idref" href="#old_state:60"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:61" class="idref" href="#msg:61"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:62" class="idref" href="#result_opt:62"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:62"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:61"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#finalize"><span class="id" title="constructor">finalize</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:63" class="idref" href="#from:63"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:59"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="current_slot:64" class="idref" href="#current_slot:64"><span class="id" title="binder">current_slot</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#chain:58"><span class="id" title="variable">chain</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#current_slot"><span class="id" title="projection">current_slot</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Only&nbsp;ethFund&nbsp;should&nbsp;be&nbsp;allowed&nbsp;to&nbsp;call&nbsp;finalize&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_valid:65" class="idref" href="#from_valid:65"><span class="id" title="binder">from_valid</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:63"><span class="id" title="variable">from</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#ethFund"><span class="id" title="definition">ethFund</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalization&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;contract&nbsp;not&nbsp;already&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized_valid:66" class="idref" href="#is_finalized_valid:66"><span class="id" title="binder">is_finalized_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:60"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalization&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;funding&nbsp;period&nbsp;is&nbsp;over&nbsp;or&nbsp;we&nbsp;hit&nbsp;the&nbsp;token&nbsp;cap&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="can_finalize_valid:67" class="idref" href="#can_finalize_valid:67"><span class="id" title="binder">can_finalize_valid</span></a> := (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:60"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingEnd"><span class="id" title="projection">fundingEnd</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#6b7621b45fff0af5e2b2cbb2bc2d4e1d"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#current_slot:64"><span class="id" title="variable">current_slot</span></a>)%<span class="id" title="var">nat</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:60"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationCap"><span class="id" title="projection">tokenCreationCap</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:60"><span class="id" title="variable">old_state</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalization&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;token&nbsp;amount<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;within&nbsp;valid&nbsp;(tokenCreationMin,&nbsp;tokenCreationCap)&nbsp;range&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="total_supply_valid:68" class="idref" href="#total_supply_valid:68"><span class="id" title="binder">total_supply_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.leb"><span class="id" title="definition">N.leb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:60"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationMin"><span class="id" title="projection">tokenCreationMin</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:60"><span class="id" title="variable">old_state</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.leb"><span class="id" title="definition">N.leb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:60"><span class="id" title="variable">old_state</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:60"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationCap"><span class="id" title="projection">tokenCreationCap</span></a>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">)</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:60"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:62"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_valid:65"><span class="id" title="variable">from_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized_valid:66"><span class="id" title="variable">is_finalized_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#can_finalize_valid:67"><span class="id" title="variable">can_finalize_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#total_supply_valid:68"><span class="id" title="variable">total_supply_valid</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;finalize<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Finalize&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_finalize}}&nbsp;contract_base_addr&nbsp;{{finalize_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="post_finalize_safe" class="idref" href="#post_finalize_safe"><span class="id" title="definition">post_finalize_safe</span></a> (<a id="chain:69" class="idref" href="#chain:69"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:70" class="idref" href="#cctx:70"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:71" class="idref" href="#old_state:71"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:72" class="idref" href="#msg:72"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:73" class="idref" href="#result_opt:73"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:73"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:72"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#finalize"><span class="id" title="constructor">finalize</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalize&nbsp;should&nbsp;not&nbsp;change&nbsp;allowances&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="allowances_unchanged:76" class="idref" href="#allowances_unchanged:76"><span class="id" title="binder">allowances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> (<span class="id" title="keyword">fun</span> <a id="fmap:74" class="idref" href="#fmap:74"><span class="id" title="binder">fmap</span></a> <a id="fmap':75" class="idref" href="#fmap':75"><span class="id" title="binder">fmap'</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap:74"><span class="id" title="variable">fmap</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap':75"><span class="id" title="variable">fmap'</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:71"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finalize&nbsp;should&nbsp;not&nbsp;change&nbsp;balances&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="other_balances_unchanged:77" class="idref" href="#other_balances_unchanged:77"><span class="id" title="binder">other_balances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_filter_eqb"><span class="id" title="definition">fmap_filter_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#batFund"><span class="id" title="definition">batFund</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:71"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:71"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:73"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#allowances_unchanged:76"><span class="id" title="variable">allowances_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#other_balances_unchanged:77"><span class="id" title="variable">other_balances_unchanged</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;finalize<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Finalize&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_finalize}}&nbsp;contract_base_addr&nbsp;{{post_finalize_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;refund&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="post_refund_update_correct" class="idref" href="#post_refund_update_correct"><span class="id" title="definition">post_refund_update_correct</span></a> (<a id="chain:78" class="idref" href="#chain:78"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:79" class="idref" href="#cctx:79"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="old_state:80" class="idref" href="#old_state:80"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>) (<a id="msg:81" class="idref" href="#msg:81"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="result_opt:82" class="idref" href="#result_opt:82"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:82"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:81"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Execution.Blockchain.html#act_transfer"><span class="id" title="constructor">Blockchain.act_transfer</span></a> <span class="id" title="var">to</span> <span class="id" title="var">amount</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#refund"><span class="id" title="constructor">refund</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:83" class="idref" href="#from:83"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:79"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="contract_balance:84" class="idref" href="#contract_balance:84"><span class="id" title="binder">contract_balance</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:79"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_contract_balance"><span class="id" title="projection">ctx_contract_balance</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_bal_old:85" class="idref" href="#from_bal_old:85"><span class="id" title="binder">from_bal_old</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:83"><span class="id" title="variable">from</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:80"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_bal_new:86" class="idref" href="#from_bal_new:86"><span class="id" title="binder">from_bal_new</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:83"><span class="id" title="variable">from</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="eth_to_refund:87" class="idref" href="#eth_to_refund:87"><span class="id" title="binder">eth_to_refund</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">Z.of_N</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_bal_old:85"><span class="id" title="variable">from_bal_old</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#be3f246709fdc565d9577f86645e6da3"><span class="id" title="notation">/</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#be3f246709fdc565d9577f86645e6da3"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:80"><span class="id" title="variable">old_state</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#be3f246709fdc565d9577f86645e6da3"><span class="id" title="notation">)</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;subtract&nbsp;the&nbsp;refunded&nbsp;account&nbsp;balance&nbsp;from&nbsp;total_supply&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="total_supply_correct:88" class="idref" href="#total_supply_correct:88"><span class="id" title="binder">total_supply_correct</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:80"><span class="id" title="variable">old_state</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_bal_old:85"><span class="id" title="variable">from_bal_old</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">-</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.modulo"><span class="id" title="definition">N.modulo</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_bal_old:85"><span class="id" title="variable">from_bal_old</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#exchangeRate_"><span class="id" title="definition">exchangeRate_</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">)</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;set&nbsp;the&nbsp;refunded&nbsp;account&nbsp;balance&nbsp;to&nbsp;0&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_correct:89" class="idref" href="#from_balance_correct:89"><span class="id" title="binder">from_balance_correct</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_bal_new:86"><span class="id" title="variable">from_bal_new</span></a> (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.modulo"><span class="id" title="definition">N.modulo</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_bal_old:85"><span class="id" title="variable">from_bal_old</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#exchangeRate_"><span class="id" title="definition">exchangeRate_</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;shoul&nbsp;pay&nbsp;the&nbsp;refunded&nbsp;account&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="action_to_correct:90" class="idref" href="#action_to_correct:90"><span class="id" title="binder">action_to_correct</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:83"><span class="id" title="variable">from</span></a> <span class="id" title="var">to</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;pay&nbsp;account_balance&nbsp;/&nbsp;exchange_rate&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="action_amount_correct:91" class="idref" href="#action_amount_correct:91"><span class="id" title="binder">action_amount_correct</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.eqb"><span class="id" title="definition">Z.eqb</span></a> <span class="id" title="var">amount</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#eth_to_refund:87"><span class="id" title="variable">eth_to_refund</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="action_to_valid:92" class="idref" href="#action_to_valid:92"><span class="id" title="binder">action_to_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> (<a class="idref" href="ConCert.Execution.Blockchain.html#address_is_contract"><span class="id" title="method">address_is_contract</span></a> <span class="id" title="var">to</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Contract&nbsp;should&nbsp;have&nbsp;enough&nbsp;money&nbsp;to&nbsp;refund&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="action_amount_valid:93" class="idref" href="#action_amount_valid:93"><span class="id" title="binder">action_amount_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.leb"><span class="id" title="definition">Z.leb</span></a> <span class="id" title="var">amount</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#contract_balance:84"><span class="id" title="variable">contract_balance</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:80"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:79"><span class="id" title="variable">cctx</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:82"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#total_supply_correct:88"><span class="id" title="variable">total_supply_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_correct:89"><span class="id" title="variable">from_balance_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action_to_correct:90"><span class="id" title="variable">action_to_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action_amount_correct:91"><span class="id" title="variable">action_amount_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action_to_valid:92"><span class="id" title="variable">action_to_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action_amount_valid:93"><span class="id" title="variable">action_amount_valid</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;refund<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;False&nbsp;property:&nbsp;Refund&nbsp;updates&nbsp;state&nbsp;correct&nbsp;and&nbsp;produces&nbsp;correct&nbsp;actions&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_refund}}&nbsp;contract_base_addr&nbsp;{{post_refund_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="refund_valid" class="idref" href="#refund_valid"><span class="id" title="definition">refund_valid</span></a> (<a id="chain:94" class="idref" href="#chain:94"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:95" class="idref" href="#cctx:95"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:96" class="idref" href="#old_state:96"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:97" class="idref" href="#msg:97"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:98" class="idref" href="#result_opt:98"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:98"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:97"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#refund"><span class="id" title="constructor">refund</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="current_slot:99" class="idref" href="#current_slot:99"><span class="id" title="binder">current_slot</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#chain:94"><span class="id" title="variable">chain</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#current_slot"><span class="id" title="projection">current_slot</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:100" class="idref" href="#from:100"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:95"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_bal_old:101" class="idref" href="#from_bal_old:101"><span class="id" title="binder">from_bal_old</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:100"><span class="id" title="variable">from</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:96"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;contract&nbsp;not&nbsp;finalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized_valid:102" class="idref" href="#is_finalized_valid:102"><span class="id" title="binder">is_finalized_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:96"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;funding&nbsp;period&nbsp;is&nbsp;over&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="current_slot_valid:103" class="idref" href="#current_slot_valid:103"><span class="id" title="binder">current_slot_valid</span></a> := (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:96"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#fundingEnd"><span class="id" title="projection">fundingEnd</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Arith.PeanoNat.html#6b7621b45fff0af5e2b2cbb2bc2d4e1d"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#current_slot:99"><span class="id" title="variable">current_slot</span></a>)%<span class="id" title="var">nat</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;contract&nbsp;did&nbsp;not&nbsp;hit&nbsp;minimum&nbsp;token&nbsp;goal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="total_supply_valid:104" class="idref" href="#total_supply_valid:104"><span class="id" title="binder">total_supply_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.ltb"><span class="id" title="definition">N.ltb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:96"><span class="id" title="variable">old_state</span></a>) <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:96"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenCreationMin"><span class="id" title="projection">tokenCreationMin</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;shoul&nbsp;only&nbsp;be&nbsp;allowed&nbsp;if&nbsp;sender&nbsp;has&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="balance_valid:105" class="idref" href="#balance_valid:105"><span class="id" title="binder">balance_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.ltb"><span class="id" title="definition">N.ltb</span></a> 0 <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_bal_old:101"><span class="id" title="variable">from_bal_old</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:96"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:98"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized_valid:102"><span class="id" title="variable">is_finalized_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#current_slot_valid:103"><span class="id" title="variable">current_slot_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#total_supply_valid:104"><span class="id" title="variable">total_supply_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#balance_valid:105"><span class="id" title="variable">balance_valid</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;refund<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Refund&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_refund}}&nbsp;contract_base_addr&nbsp;{{refund_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="post_refund_safe" class="idref" href="#post_refund_safe"><span class="id" title="definition">post_refund_safe</span></a> (<a id="chain:106" class="idref" href="#chain:106"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:107" class="idref" href="#cctx:107"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:108" class="idref" href="#old_state:108"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:109" class="idref" href="#msg:109"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:110" class="idref" href="#result_opt:110"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:110"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:109"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#refund"><span class="id" title="constructor">refund</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:111" class="idref" href="#from:111"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:107"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;not&nbsp;change&nbsp;isFinalized&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized_unchanged:112" class="idref" href="#is_finalized_unchanged:112"><span class="id" title="binder">is_finalized_unchanged</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Bool.Bool.html#eqb"><span class="id" title="definition">Bool.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:108"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;not&nbsp;change&nbsp;allowances&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="allowances_unchanged:115" class="idref" href="#allowances_unchanged:115"><span class="id" title="binder">allowances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> (<span class="id" title="keyword">fun</span> <a id="fmap:113" class="idref" href="#fmap:113"><span class="id" title="binder">fmap</span></a> <a id="fmap':114" class="idref" href="#fmap':114"><span class="id" title="binder">fmap'</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap:113"><span class="id" title="variable">fmap</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap':114"><span class="id" title="variable">fmap'</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:108"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Refund&nbsp;should&nbsp;not&nbsp;change&nbsp;other&nbsp;balances&nbsp;than&nbsp;the&nbsp;senders&nbsp;balance&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="other_balances_unchanged:116" class="idref" href="#other_balances_unchanged:116"><span class="id" title="binder">other_balances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_filter_eqb"><span class="id" title="definition">fmap_filter_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:111"><span class="id" title="variable">from</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:108"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:108"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:110"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized_unchanged:112"><span class="id" title="variable">is_finalized_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#allowances_unchanged:115"><span class="id" title="variable">allowances_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#other_balances_unchanged:116"><span class="id" title="variable">other_balances_unchanged</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;refund<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Refund&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_refund}}&nbsp;contract_base_addr&nbsp;{{post_refund_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;transfer&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="post_transfer_update_correct" class="idref" href="#post_transfer_update_correct"><span class="id" title="definition">post_transfer_update_correct</span></a> (<a id="chain:117" class="idref" href="#chain:117"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:118" class="idref" href="#cctx:118"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="old_state:119" class="idref" href="#old_state:119"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>) (<a id="msg:120" class="idref" href="#msg:120"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="result_opt:121" class="idref" href="#result_opt:121"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:121"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:120"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#transfer"><span class="id" title="constructor">EIP20Token.transfer</span></a> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:122" class="idref" href="#from:122"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:118"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_before:123" class="idref" href="#from_balance_before:123"><span class="id" title="binder">from_balance_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:122"><span class="id" title="variable">from</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:119"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="to_balance_before:124" class="idref" href="#to_balance_before:124"><span class="id" title="binder">to_balance_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">to</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:119"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_after:125" class="idref" href="#from_balance_after:125"><span class="id" title="binder">from_balance_after</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:122"><span class="id" title="variable">from</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="to_balance_after:126" class="idref" href="#to_balance_after:126"><span class="id" title="binder">to_balance_after</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">to</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_to_same:127" class="idref" href="#from_to_same:127"><span class="id" title="binder">from_to_same</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:122"><span class="id" title="variable">from</span></a> <span class="id" title="var">to</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;must&nbsp;subtract&nbsp;the&nbsp;transfered&nbsp;tokens&nbsp;from&nbsp;the&nbsp;"from"&nbsp;address<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;the&nbsp;"from&nbsp;&lt;&gt;&nbsp;to"&nbsp;otherwise&nbsp;the&nbsp;balance&nbsp;should&nbsp;remain&nbsp;the&nbsp;same&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_correct:128" class="idref" href="#from_balance_correct:128"><span class="id" title="binder">from_balance_correct</span></a> := <span class="id" title="keyword">if</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_to_same:127"><span class="id" title="variable">from_to_same</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_before:123"><span class="id" title="variable">from_balance_before</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_after:125"><span class="id" title="variable">from_balance_after</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_before:123"><span class="id" title="variable">from_balance_before</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_after:125"><span class="id" title="variable">from_balance_after</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <span class="id" title="var">tokens</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;must&nbsp;add&nbsp;the&nbsp;transfered&nbsp;tokens&nbsp;from&nbsp;the&nbsp;"to"&nbsp;address<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;the&nbsp;"from&nbsp;&lt;&gt;&nbsp;to"&nbsp;otherwise&nbsp;the&nbsp;balance&nbsp;should&nbsp;remain&nbsp;the&nbsp;same&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="to_balance_correct:129" class="idref" href="#to_balance_correct:129"><span class="id" title="binder">to_balance_correct</span></a> := <span class="id" title="keyword">if</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_to_same:127"><span class="id" title="variable">from_to_same</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_before:124"><span class="id" title="variable">to_balance_before</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_after:126"><span class="id" title="variable">to_balance_after</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_before:124"><span class="id" title="variable">to_balance_before</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <span class="id" title="var">tokens</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_after:126"><span class="id" title="variable">to_balance_after</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:119"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:121"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_correct:128"><span class="id" title="variable">from_balance_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_correct:129"><span class="id" title="variable">to_balance_correct</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer&nbsp;updates&nbsp;output&nbsp;correct&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer}}&nbsp;contract_base_addr&nbsp;{{post_transfer_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="transfer_valid" class="idref" href="#transfer_valid"><span class="id" title="definition">transfer_valid</span></a> (<a id="chain:130" class="idref" href="#chain:130"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:131" class="idref" href="#cctx:131"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:132" class="idref" href="#old_state:132"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:133" class="idref" href="#msg:133"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:134" class="idref" href="#result_opt:134"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:134"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:133"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#transfer"><span class="id" title="constructor">EIP20Token.transfer</span></a> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:135" class="idref" href="#from:135"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:131"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount:136" class="idref" href="#amount:136"><span class="id" title="binder">amount</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:131"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_amount"><span class="id" title="projection">ctx_amount</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_before:137" class="idref" href="#from_balance_before:137"><span class="id" title="binder">from_balance_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:135"><span class="id" title="variable">from</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:132"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;should&nbsp;only&nbsp;return&nbsp;some&nbsp;if&nbsp;"from"&nbsp;has&nbsp;enough&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_valid:138" class="idref" href="#from_balance_valid:138"><span class="id" title="binder">from_balance_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.leb"><span class="id" title="definition">N.leb</span></a> <span class="id" title="var">tokens</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_before:137"><span class="id" title="variable">from_balance_before</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;call&nbsp;must&nbsp;not&nbsp;be&nbsp;payable&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount_valid:139" class="idref" href="#amount_valid:139"><span class="id" title="binder">amount_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.eqb"><span class="id" title="definition">Z.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount:136"><span class="id" title="variable">amount</span></a> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:132"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:134"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount_valid:139"><span class="id" title="variable">amount_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_valid:138"><span class="id" title="variable">from_balance_valid</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer}}&nbsp;contract_base_addr&nbsp;{{transfer_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="post_transfer_safe" class="idref" href="#post_transfer_safe"><span class="id" title="definition">post_transfer_safe</span></a> (<a id="chain:140" class="idref" href="#chain:140"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:141" class="idref" href="#cctx:141"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:142" class="idref" href="#old_state:142"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:143" class="idref" href="#msg:143"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:144" class="idref" href="#result_opt:144"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:144"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:143"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#transfer"><span class="id" title="constructor">EIP20Token.transfer</span></a> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:145" class="idref" href="#from:145"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:141"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;should&nbsp;not&nbsp;change&nbsp;the&nbsp;finalization&nbsp;state&nbsp;of&nbsp;the&nbsp;token&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized_unchanged:146" class="idref" href="#is_finalized_unchanged:146"><span class="id" title="binder">is_finalized_unchanged</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Bool.Bool.html#eqb"><span class="id" title="definition">Bool.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:142"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;should&nbsp;not&nbsp;change&nbsp;the&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="total_supply_unchanged:147" class="idref" href="#total_supply_unchanged:147"><span class="id" title="binder">total_supply_unchanged</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:142"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;allowances&nbsp;of&nbsp;any&nbsp;account&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="allowances_unchanged:150" class="idref" href="#allowances_unchanged:150"><span class="id" title="binder">allowances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> (<span class="id" title="keyword">fun</span> <a id="fmap:148" class="idref" href="#fmap:148"><span class="id" title="binder">fmap</span></a> <a id="fmap':149" class="idref" href="#fmap':149"><span class="id" title="binder">fmap'</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap:148"><span class="id" title="variable">fmap</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap':149"><span class="id" title="variable">fmap'</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:142"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer&nbsp;must&nbsp;only&nbsp;change&nbsp;the&nbsp;balance&nbsp;of&nbsp;from&nbsp;and&nbsp;to&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="other_balances_unchanged:151" class="idref" href="#other_balances_unchanged:151"><span class="id" title="binder">other_balances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_filter_eqb"><span class="id" title="definition">fmap_filter_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:145"><span class="id" title="variable">from</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <span class="id" title="var">to</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:142"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:142"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:144"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized_unchanged:146"><span class="id" title="variable">is_finalized_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#total_supply_unchanged:147"><span class="id" title="variable">total_supply_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#allowances_unchanged:150"><span class="id" title="variable">allowances_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#other_balances_unchanged:151"><span class="id" title="variable">other_balances_unchanged</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer}}&nbsp;contract_base_addr&nbsp;{{post_transfer_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;transfer_from&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="post_transfer_from_update_correct" class="idref" href="#post_transfer_from_update_correct"><span class="id" title="definition">post_transfer_from_update_correct</span></a> (<a id="chain:152" class="idref" href="#chain:152"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:153" class="idref" href="#cctx:153"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="old_state:154" class="idref" href="#old_state:154"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>) (<a id="msg:155" class="idref" href="#msg:155"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="result_opt:156" class="idref" href="#result_opt:156"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:156"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:155"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#transfer_from"><span class="id" title="constructor">EIP20Token.transfer_from</span></a> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delegate:157" class="idref" href="#delegate:157"><span class="id" title="binder">delegate</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:153"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_before:158" class="idref" href="#from_balance_before:158"><span class="id" title="binder">from_balance_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">from</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:154"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="to_balance_before:159" class="idref" href="#to_balance_before:159"><span class="id" title="binder">to_balance_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">to</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:154"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_after:160" class="idref" href="#from_balance_after:160"><span class="id" title="binder">from_balance_after</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">from</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="to_balance_after:161" class="idref" href="#to_balance_after:161"><span class="id" title="binder">to_balance_after</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">to</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delegate_allowance_before:162" class="idref" href="#delegate_allowance_before:162"><span class="id" title="binder">delegate_allowance_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delegate:157"><span class="id" title="variable">delegate</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> (@<a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a> (<a class="idref" href="ConCert.Execution.Containers.html#FMap"><span class="id" title="abbreviation">FMap</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#TokenValue"><span class="id" title="definition">TokenValue</span></a>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">from</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:154"><span class="id" title="variable">old_state</span></a>)))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delegate_allowance_after:163" class="idref" href="#delegate_allowance_after:163"><span class="id" title="binder">delegate_allowance_after</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delegate:157"><span class="id" title="variable">delegate</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> (@<a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a> (<a class="idref" href="ConCert.Execution.Containers.html#FMap"><span class="id" title="abbreviation">FMap</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#TokenValue"><span class="id" title="definition">TokenValue</span></a>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">from</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>)))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_to_same:164" class="idref" href="#from_to_same:164"><span class="id" title="binder">from_to_same</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#address_eqb"><span class="id" title="method">address_eqb</span></a> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;subtract&nbsp;the&nbsp;transfered&nbsp;tokens&nbsp;from&nbsp;the&nbsp;"from"&nbsp;address<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;the&nbsp;"from&nbsp;&lt;&gt;&nbsp;to"&nbsp;otherwise&nbsp;the&nbsp;balance&nbsp;should&nbsp;remain&nbsp;the&nbsp;same&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_correct:165" class="idref" href="#from_balance_correct:165"><span class="id" title="binder">from_balance_correct</span></a> := <span class="id" title="keyword">if</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_to_same:164"><span class="id" title="variable">from_to_same</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_before:158"><span class="id" title="variable">from_balance_before</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_after:160"><span class="id" title="variable">from_balance_after</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_before:158"><span class="id" title="variable">from_balance_before</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_after:160"><span class="id" title="variable">from_balance_after</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <span class="id" title="var">tokens</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;add&nbsp;the&nbsp;transfered&nbsp;tokens&nbsp;to&nbsp;the&nbsp;"to"&nbsp;address<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;the&nbsp;"from&nbsp;&lt;&gt;&nbsp;to"&nbsp;otherwise&nbsp;the&nbsp;balance&nbsp;should&nbsp;remain&nbsp;the&nbsp;same&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="to_balance_correct:166" class="idref" href="#to_balance_correct:166"><span class="id" title="binder">to_balance_correct</span></a> := <span class="id" title="keyword">if</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_to_same:164"><span class="id" title="variable">from_to_same</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_before:159"><span class="id" title="variable">to_balance_before</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_after:161"><span class="id" title="variable">to_balance_after</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_before:159"><span class="id" title="variable">to_balance_before</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <span class="id" title="var">tokens</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_after:161"><span class="id" title="variable">to_balance_after</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;subtract&nbsp;the&nbsp;number&nbsp;of&nbsp;transfered&nbsp;tokens&nbsp;from&nbsp;the&nbsp;delegates&nbsp;allowance&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delefate_allowance_correct:167" class="idref" href="#delefate_allowance_correct:167"><span class="id" title="binder">delefate_allowance_correct</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delegate_allowance_before:162"><span class="id" title="variable">delegate_allowance_before</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delegate_allowance_after:163"><span class="id" title="variable">delegate_allowance_after</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <span class="id" title="var">tokens</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:154"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:156"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_correct:165"><span class="id" title="variable">from_balance_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#to_balance_correct:166"><span class="id" title="variable">to_balance_correct</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delefate_allowance_correct:167"><span class="id" title="variable">delefate_allowance_correct</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer_from<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer_from&nbsp;updates&nbsp;output&nbsp;correct&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer_from}}&nbsp;contract_base_addr&nbsp;{{post_transfer_from_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="transfer_from_valid" class="idref" href="#transfer_from_valid"><span class="id" title="definition">transfer_from_valid</span></a> (<a id="chain:168" class="idref" href="#chain:168"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:169" class="idref" href="#cctx:169"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:170" class="idref" href="#old_state:170"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:171" class="idref" href="#msg:171"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:172" class="idref" href="#result_opt:172"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:172"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:171"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#transfer_from"><span class="id" title="constructor">EIP20Token.transfer_from</span></a> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delegate:173" class="idref" href="#delegate:173"><span class="id" title="binder">delegate</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:169"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount:174" class="idref" href="#amount:174"><span class="id" title="binder">amount</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:169"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_amount"><span class="id" title="projection">ctx_amount</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_before:175" class="idref" href="#from_balance_before:175"><span class="id" title="binder">from_balance_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">from</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:170"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delegate_allowance_before:176" class="idref" href="#delegate_allowance_before:176"><span class="id" title="binder">delegate_allowance_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delegate:173"><span class="id" title="variable">delegate</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> (@<a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a> (<a class="idref" href="ConCert.Execution.Containers.html#FMap"><span class="id" title="abbreviation">FMap</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#TokenValue"><span class="id" title="definition">TokenValue</span></a>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">from</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:170"><span class="id" title="variable">old_state</span></a>)))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;only&nbsp;succeed&nbsp;if&nbsp;"from"&nbsp;has&nbsp;enough&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_balance_valid:177" class="idref" href="#from_balance_valid:177"><span class="id" title="binder">from_balance_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.leb"><span class="id" title="definition">N.leb</span></a> <span class="id" title="var">tokens</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_before:175"><span class="id" title="variable">from_balance_before</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;only&nbsp;succeed&nbsp;if&nbsp;"delegate"&nbsp;is&nbsp;allowed<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;transfer&nbsp;the&nbsp;requested&nbsp;amount&nbsp;of&nbsp;tokens&nbsp;on&nbsp;behalf&nbsp;of&nbsp;"from"&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delegate_allowance_valid:178" class="idref" href="#delegate_allowance_valid:178"><span class="id" title="binder">delegate_allowance_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.leb"><span class="id" title="definition">N.leb</span></a> <span class="id" title="var">tokens</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delegate_allowance_before:176"><span class="id" title="variable">delegate_allowance_before</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Tranfer_from&nbsp;must&nbsp;not&nbsp;be&nbsp;payable*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount_valid:179" class="idref" href="#amount_valid:179"><span class="id" title="binder">amount_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.eqb"><span class="id" title="definition">Z.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount:174"><span class="id" title="variable">amount</span></a> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:170"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:172"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount_valid:179"><span class="id" title="variable">amount_valid</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_balance_valid:177"><span class="id" title="variable">from_balance_valid</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer_from<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer_from&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer_from}}&nbsp;contract_base_addr&nbsp;{{transfer_from_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="post_transfer_from_safe" class="idref" href="#post_transfer_from_safe"><span class="id" title="definition">post_transfer_from_safe</span></a> (<a id="chain:180" class="idref" href="#chain:180"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:181" class="idref" href="#cctx:181"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:182" class="idref" href="#old_state:182"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:183" class="idref" href="#msg:183"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:184" class="idref" href="#result_opt:184"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:184"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:183"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#transfer_from"><span class="id" title="constructor">EIP20Token.transfer_from</span></a> <span class="id" title="var">from</span> <span class="id" title="var">to</span> <span class="id" title="var">tokens</span>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delegate:185" class="idref" href="#delegate:185"><span class="id" title="binder">delegate</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:181"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_allowances_before:186" class="idref" href="#from_allowances_before:186"><span class="id" title="binder">from_allowances_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> (@<a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a> (<a class="idref" href="ConCert.Execution.Containers.html#FMap"><span class="id" title="abbreviation">FMap</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#TokenValue"><span class="id" title="definition">TokenValue</span></a>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">from</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:182"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_allowances_after:187" class="idref" href="#from_allowances_after:187"><span class="id" title="binder">from_allowances_after</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> (@<a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a> (<a class="idref" href="ConCert.Execution.Containers.html#FMap"><span class="id" title="abbreviation">FMap</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#TokenValue"><span class="id" title="definition">TokenValue</span></a>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">from</span> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;finalization&nbsp;state&nbsp;of&nbsp;the&nbsp;token&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized_unchanged:188" class="idref" href="#is_finalized_unchanged:188"><span class="id" title="binder">is_finalized_unchanged</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Bool.Bool.html#eqb"><span class="id" title="definition">Bool.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:182"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="total_supply_unchanged:189" class="idref" href="#total_supply_unchanged:189"><span class="id" title="binder">total_supply_unchanged</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:182"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;allowances&nbsp;of&nbsp;other&nbsp;accounts&nbsp;than&nbsp;from&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="other_allowances_unchanged:192" class="idref" href="#other_allowances_unchanged:192"><span class="id" title="binder">other_allowances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_filter_eqb"><span class="id" title="definition">fmap_filter_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><span class="id" title="var">from</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="fmap:190" class="idref" href="#fmap:190"><span class="id" title="binder">fmap</span></a> <a id="fmap':191" class="idref" href="#fmap':191"><span class="id" title="binder">fmap'</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap:190"><span class="id" title="variable">fmap</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap':191"><span class="id" title="variable">fmap'</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:182"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="other_allowance_unchanged:193" class="idref" href="#other_allowance_unchanged:193"><span class="id" title="binder">other_allowance_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_filter_eqb"><span class="id" title="definition">fmap_filter_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delegate:185"><span class="id" title="variable">delegate</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_allowances_before:186"><span class="id" title="variable">from_allowances_before</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_allowances_after:187"><span class="id" title="variable">from_allowances_after</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;balances&nbsp;of&nbsp;other&nbsp;accounts&nbsp;than&nbsp;from&nbsp;and&nbsp;to&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="other_balances_unchanged:194" class="idref" href="#other_balances_unchanged:194"><span class="id" title="binder">other_balances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_filter_eqb"><span class="id" title="definition">fmap_filter_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><span class="id" title="var">from</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <span class="id" title="var">to</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:182"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:182"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:184"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized_unchanged:188"><span class="id" title="variable">is_finalized_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#total_supply_unchanged:189"><span class="id" title="variable">total_supply_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#other_allowances_unchanged:192"><span class="id" title="variable">other_allowances_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#other_allowance_unchanged:193"><span class="id" title="variable">other_allowance_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#other_balances_unchanged:194"><span class="id" title="variable">other_balances_unchanged</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;transfer_from<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Transfer_from&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_transfer_from}}&nbsp;contract_base_addr&nbsp;{{post_transfer_from_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;approve&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="post_approve_update_correct" class="idref" href="#post_approve_update_correct"><span class="id" title="definition">post_approve_update_correct</span></a> (<a id="chain:195" class="idref" href="#chain:195"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:196" class="idref" href="#cctx:196"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="old_state:197" class="idref" href="#old_state:197"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>) (<a id="msg:198" class="idref" href="#msg:198"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="result_opt:199" class="idref" href="#result_opt:199"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:199"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:198"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#approve"><span class="id" title="constructor">EIP20Token.approve</span></a> <span class="id" title="var">delegate</span> <span class="id" title="var">tokens</span>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:200" class="idref" href="#from:200"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:196"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delegate_allowance_after:201" class="idref" href="#delegate_allowance_after:201"><span class="id" title="binder">delegate_allowance_after</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> 0 (<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <span class="id" title="var">delegate</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> (@<a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a> (<a class="idref" href="ConCert.Execution.Containers.html#FMap"><span class="id" title="abbreviation">FMap</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#TokenValue"><span class="id" title="definition">TokenValue</span></a>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:200"><span class="id" title="variable">from</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>)))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Approve&nbsp;should&nbsp;update&nbsp;the&nbsp;allowance&nbsp;of&nbsp;"delegate"&nbsp;correctly&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="delefate_allowance_correct:202" class="idref" href="#delefate_allowance_correct:202"><span class="id" title="binder">delefate_allowance_correct</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delegate_allowance_after:201"><span class="id" title="variable">delegate_allowance_after</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <span class="id" title="var">tokens</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:197"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:199"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#delefate_allowance_correct:202"><span class="id" title="variable">delefate_allowance_correct</span></a>)<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;approve<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Approve&nbsp;updates&nbsp;output&nbsp;correct&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_approve}}&nbsp;contract_base_addr&nbsp;{{post_approve_update_correct}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="approve_valid" class="idref" href="#approve_valid"><span class="id" title="definition">approve_valid</span></a> (<a id="chain:203" class="idref" href="#chain:203"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:204" class="idref" href="#cctx:204"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:205" class="idref" href="#old_state:205"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:206" class="idref" href="#msg:206"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:207" class="idref" href="#result_opt:207"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:207"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:206"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#approve"><span class="id" title="constructor">EIP20Token.approve</span></a> <span class="id" title="var">delegate</span> <span class="id" title="var">tokens</span>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount:208" class="idref" href="#amount:208"><span class="id" title="binder">amount</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:204"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_amount"><span class="id" title="projection">ctx_amount</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Approve&nbsp;must&nbsp;not&nbsp;be&nbsp;payable&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="amount_valid:209" class="idref" href="#amount_valid:209"><span class="id" title="binder">amount_valid</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.eqb"><span class="id" title="definition">Z.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount:208"><span class="id" title="variable">amount</span></a> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:205"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:207"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#amount_valid:209"><span class="id" title="variable">amount_valid</span></a>)<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;approve<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Approve&nbsp;contract&nbsp;calls&nbsp;are&nbsp;valid&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_approve}}&nbsp;contract_base_addr&nbsp;{{approve_valid}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="post_approve_safe" class="idref" href="#post_approve_safe"><span class="id" title="definition">post_approve_safe</span></a> (<a id="chain:210" class="idref" href="#chain:210"><span class="id" title="binder">chain</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#Chain"><span class="id" title="record">Chain</span></a>) (<a id="cctx:211" class="idref" href="#cctx:211"><span class="id" title="binder">cctx</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ContractCallContext"><span class="id" title="record">ContractCallContext</span></a>) (<a id="old_state:212" class="idref" href="#old_state:212"><span class="id" title="binder">old_state</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="msg:213" class="idref" href="#msg:213"><span class="id" title="binder">msg</span></a> : <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a>) (<a id="result_opt:214" class="idref" href="#result_opt:214"><span class="id" title="binder">result_opt</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac4"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#ActionBody"><span class="id" title="inductive">ActionBody</span></a>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:214"><span class="id" title="variable">result_opt</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#msg:213"><span class="id" title="variable">msg</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">new_state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">),</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenMsg"><span class="id" title="constructor">tokenMsg</span></a> (<a class="idref" href="ConCert.Examples.EIP20.EIP20Token.html#approve"><span class="id" title="constructor">EIP20Token.approve</span></a> <span class="id" title="var">delegate</span> <span class="id" title="var">tokens</span>)<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from:215" class="idref" href="#from:215"><span class="id" title="binder">from</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cctx:211"><span class="id" title="variable">cctx</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#ctx_from"><span class="id" title="projection">ctx_from</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_allowances_before:216" class="idref" href="#from_allowances_before:216"><span class="id" title="binder">from_allowances_before</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> (@<a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a> (<a class="idref" href="ConCert.Execution.Containers.html#FMap"><span class="id" title="abbreviation">FMap</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#TokenValue"><span class="id" title="definition">TokenValue</span></a>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:215"><span class="id" title="variable">from</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:212"><span class="id" title="variable">old_state</span></a>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="from_allowances_after:217" class="idref" href="#from_allowances_after:217"><span class="id" title="binder">from_allowances_after</span></a> := <a class="idref" href="ConCert.Utils.Extras.html#with_default"><span class="id" title="definition">with_default</span></a> (@<a class="idref" href="ConCert.Execution.Containers.html#FMap.empty"><span class="id" title="abbreviation">FMap.empty</span></a> (<a class="idref" href="ConCert.Execution.Containers.html#FMap"><span class="id" title="abbreviation">FMap</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#Address"><span class="id" title="method">Address</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#TokenValue"><span class="id" title="definition">TokenValue</span></a>) <span class="id" title="var">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Containers.html#FMap.find"><span class="id" title="abbreviation">FMap.find</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:215"><span class="id" title="variable">from</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Approve&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;finalization&nbsp;state&nbsp;of&nbsp;the&nbsp;token&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized_unchanged:218" class="idref" href="#is_finalized_unchanged:218"><span class="id" title="binder">is_finalized_unchanged</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Bool.Bool.html#eqb"><span class="id" title="definition">Bool.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:212"><span class="id" title="variable">old_state</span></a>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="var">new_state</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="total_supply_unchanged:219" class="idref" href="#total_supply_unchanged:219"><span class="id" title="binder">total_supply_unchanged</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:212"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;allowances&nbsp;of&nbsp;other&nbsp;accounts&nbsp;than&nbsp;"delegate"&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="other_allowances_unchanged:222" class="idref" href="#other_allowances_unchanged:222"><span class="id" title="binder">other_allowances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_filter_eqb"><span class="id" title="definition">fmap_filter_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from:215"><span class="id" title="variable">from</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="fmap:220" class="idref" href="#fmap:220"><span class="id" title="binder">fmap</span></a> <a id="fmap':221" class="idref" href="#fmap':221"><span class="id" title="binder">fmap'</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap:220"><span class="id" title="variable">fmap</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#fmap':221"><span class="id" title="variable">fmap'</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:212"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#allowances"><span class="id" title="definition">allowances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="other_allowance_unchanged:223" class="idref" href="#other_allowance_unchanged:223"><span class="id" title="binder">other_allowance_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_filter_eqb"><span class="id" title="definition">fmap_filter_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">[</span></a><span class="id" title="var">delegate</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#ddd65c2f7ee73ecec433744948d846bb"><span class="id" title="notation">]</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_allowances_before:216"><span class="id" title="variable">from_allowances_before</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#from_allowances_after:217"><span class="id" title="variable">from_allowances_after</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Transfer_from&nbsp;must&nbsp;not&nbsp;change&nbsp;the&nbsp;balances&nbsp;of&nbsp;any&nbsp;accounts&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="balances_unchanged:224" class="idref" href="#balances_unchanged:224"><span class="id" title="binder">balances_unchanged</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#fmap_eqb"><span class="id" title="definition">fmap_eqb</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.eqb"><span class="id" title="definition">N.eqb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:212"><span class="id" title="variable">old_state</span></a>) (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#balances"><span class="id" title="definition">balances</span></a> <span class="id" title="var">new_state</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">whenFail</span> (<span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#old_state:212"><span class="id" title="variable">old_state</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="definition">nl</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Strings.String.html#169ad156fbc6036a53a0338819a2b301"><span class="id" title="notation">++</span></a> <span class="id" title="method">show</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#result_opt:214"><span class="id" title="variable">result_opt</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized_unchanged:218"><span class="id" title="variable">is_finalized_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#total_supply_unchanged:219"><span class="id" title="variable">total_supply_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#other_allowances_unchanged:222"><span class="id" title="variable">other_allowances_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#other_allowance_unchanged:223"><span class="id" title="variable">other_allowance_unchanged</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#balances_unchanged:224"><span class="id" title="variable">balances_unchanged</span></a>))<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;'receive'&nbsp;failed,&nbsp;or&nbsp;msg&nbsp;is&nbsp;not&nbsp;a&nbsp;approve<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;just&nbsp;discard&nbsp;this&nbsp;test&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Approve&nbsp;contract&nbsp;calls&nbsp;does&nbsp;not&nbsp;change&nbsp;anything&nbsp;they&nbsp;shouldnt&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{msg_is_approve}}&nbsp;contract_base_addr&nbsp;{{post_approve_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;contract&nbsp;balance&nbsp;tests&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="contract_balance_lower_bound" class="idref" href="#contract_balance_lower_bound"><span class="id" title="definition">contract_balance_lower_bound</span></a> (<a id="cs:225" class="idref" href="#cs:225"><span class="id" title="binder">cs</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ChainState"><span class="id" title="record">ChainState</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="contract_balance:226" class="idref" href="#contract_balance:226"><span class="id" title="binder">contract_balance</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:225"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:225"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalized:227" class="idref" href="#is_finalized:227"><span class="id" title="binder">is_finalized</span></a> := <span class="id" title="var">cstate</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="contract_balance_correct:228" class="idref" href="#contract_balance_correct:228"><span class="id" title="binder">contract_balance_correct</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.geb"><span class="id" title="definition">Z.geb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#contract_balance:226"><span class="id" title="variable">contract_balance</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">Z.of_N</span></a> (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#be3f246709fdc565d9577f86645e6da3"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">cstate</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#be3f246709fdc565d9577f86645e6da3"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#be3f246709fdc565d9577f86645e6da3"><span class="id" title="notation">/</span></a> <span class="id" title="var">cstate</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalized:227"><span class="id" title="variable">is_finalized</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="method">checker</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#contract_balance_correct:228"><span class="id" title="variable">contract_balance_correct</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Contract&nbsp;balance&nbsp;should&nbsp;always&nbsp;be&nbsp;at&nbsp;least&nbsp;as&nbsp;big&nbsp;as&nbsp;the&nbsp;number&nbsp;of&nbsp;refundable&nbsp;tokens<br/>
&nbsp;&nbsp;&nbsp;&nbsp;divided&nbsp;by&nbsp;the&nbsp;exhange&nbsp;rate&nbsp;unless&nbsp;the&nbsp;token&nbsp;was&nbsp;successfully&nbsp;funded.<br/>
&nbsp;&nbsp;&nbsp;If&nbsp;this&nbsp;property&nbsp;does&nbsp;not&nbsp;hold&nbsp;then&nbsp;it&nbsp;implies&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;cases&nbsp;where&nbsp;a&nbsp;user<br/>
&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;get&nbsp;a&nbsp;refund&nbsp;should&nbsp;the&nbsp;funding&nbsp;fail.<br/>
*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{contract_balance_lower_bound}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="partially_funded_cb" class="idref" href="#partially_funded_cb"><span class="id" title="definition">partially_funded_cb</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.ResultMonad.html#unpack_result"><span class="id" title="definition">ResultMonad.unpack_result</span></a> (<a class="idref" href="ConCert.Execution.Test.TraceGens.html#add_block"><span class="id" title="definition">TraceGens.add_block</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#empty_chain"><span class="id" title="definition">empty_chain</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> 10<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_2"><span class="id" title="definition">person_2</span></a> 7<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_3"><span class="id" title="definition">person_3</span></a> 6<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_4"><span class="id" title="definition">person_4</span></a> 10<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_deploy"><span class="id" title="definition">build_deploy</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> 0 <a class="idref" href="ConCert.Examples.BAT.BATAltFix.html#contract"><span class="id" title="definition">BATAltFix.contract</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#bat_setup"><span class="id" title="definition">bat_setup</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_call"><span class="id" title="definition">build_call</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> 1 <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#create_tokens"><span class="id" title="constructor">create_tokens</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;fully&nbsp;refund&nbsp;from&nbsp;a&nbsp;state<br/>
&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;at&nbsp;least&nbsp;one&nbsp;token&nbsp;was&nbsp;created<br/>
&nbsp;&nbsp;&nbsp;&nbsp;i.e.&nbsp;contract&nbsp;balance&nbsp;=&nbsp;0&nbsp;and&nbsp;token&nbsp;not&nbsp;funded.<br/>
&nbsp;&nbsp;&nbsp;Note&nbsp;that&nbsp;this&nbsp;does&nbsp;not&nbsp;mean&nbsp;that&nbsp;the&nbsp;correct&nbsp;people&nbsp;got&nbsp;refunds<br/>
&nbsp;&nbsp;&nbsp;the&nbsp;tests&nbsp;only&nbsp;states&nbsp;that&nbsp;all&nbsp;money&nbsp;put&nbsp;into&nbsp;the&nbsp;contract&nbsp;was<br/>
&nbsp;&nbsp;&nbsp;refunded,&nbsp;i.e.&nbsp;no&nbsp;money&nbsp;get&nbsp;stuck&nbsp;in&nbsp;the&nbsp;contract&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(partially_funded_cb&nbsp;~~&gt;&nbsp;is_fully_refunded).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
Chain{|<br/>
Block&nbsp;1&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">11%256,</span> <span class="inlinecode">10)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">12%256,</span> <span class="inlinecode">7)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">13%256,</span> <span class="inlinecode">6)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">14%256,</span> <span class="inlinecode">10)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_deploy</span></span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">transfer</span></span> <span class="inlinecode">19%256</span> <span class="inlinecode">17)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">1,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;2&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">17%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">transfer</span></span> <span class="inlinecode">14%256</span> <span class="inlinecode">3)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">12%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">4,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;3&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">4,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">14%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">approve</span></span> <span class="inlinecode">12%256</span> <span class="inlinecode">0)}</span>;<br/>
Block&nbsp;4&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">12%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">transfer_from</span></span> <span class="inlinecode">14%256</span> <span class="inlinecode">17%256</span> <span class="inlinecode">0)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">12%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">approve</span></span> <span class="inlinecode">11%256</span> <span class="inlinecode">0)}</span>;<br/>
Block&nbsp;5&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">3,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">12%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;6&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">refund</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">12%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">refund</span>)}</span>;&nbsp;|}<br/>
<br/>
Success&nbsp;-&nbsp;found&nbsp;witness&nbsp;satisfying&nbsp;the&nbsp;predicate!<br/>
+++&nbsp;Failed&nbsp;(as&nbsp;expected)&nbsp;after&nbsp;13&nbsp;tests&nbsp;and&nbsp;0&nbsp;shrinks.&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="can_always_fully_refund" class="idref" href="#can_always_fully_refund"><span class="id" title="definition">can_always_fully_refund</span></a> (<a id="cs:229" class="idref" href="#cs:229"><span class="id" title="binder">cs</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ChainState"><span class="id" title="record">ChainState</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="no_actions_from_contract:232" class="idref" href="#no_actions_from_contract:232"><span class="id" title="binder">no_actions_from_contract</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#fold_left"><span class="id" title="definition">fold_left</span></a> (<span class="id" title="keyword">fun</span> <a id="b:230" class="idref" href="#b:230"><span class="id" title="binder">b</span></a> <a id="action:231" class="idref" href="#action:231"><span class="id" title="binder">action</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#b:230"><span class="id" title="variable">b</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> (<a class="idref" href="ConCert.Execution.Blockchain.html#address_is_contract"><span class="id" title="method">address_is_contract</span></a> (<a class="idref" href="ConCert.Execution.Blockchain.html#act_from"><span class="id" title="projection">act_from</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action:231"><span class="id" title="variable">action</span></a>))<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">)</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Blockchain.html#chain_state_queue"><span class="id" title="projection">chain_state_queue</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:229"><span class="id" title="variable">cs</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="contract_balance:233" class="idref" href="#contract_balance:233"><span class="id" title="binder">contract_balance</span></a> := <a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:229"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:229"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="contract_balance_correct:234" class="idref" href="#contract_balance_correct:234"><span class="id" title="binder">contract_balance_correct</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.leb"><span class="id" title="definition">Z.leb</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#contract_balance:233"><span class="id" title="variable">contract_balance</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#d3ea1afb7d81263dc23c4eb0da2a3c4e"><span class="id" title="notation">*</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">Z.of_N</span></a> <span class="id" title="var">cstate</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#tokenExchangeRate"><span class="id" title="projection">tokenExchangeRate</span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.of_N"><span class="id" title="definition">Z.of_N</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">cstate</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#no_actions_from_contract:232"><span class="id" title="variable">no_actions_from_contract</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">cstate</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="method">checker</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#contract_balance_correct:234"><span class="id" title="variable">contract_balance_correct</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Above&nbsp;we&nbsp;showed&nbsp;that&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;completely&nbsp;empty&nbsp;the&nbsp;contract&nbsp;balance,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;however&nbsp;the&nbsp;ideally&nbsp;it&nbsp;should&nbsp;always&nbsp;be&nbsp;possible&nbsp;to&nbsp;empty&nbsp;the&nbsp;contract&nbsp;balance.<br/>
&nbsp;&nbsp;&nbsp;If&nbsp;not&nbsp;then&nbsp;it&nbsp;would&nbsp;mean&nbsp;that&nbsp;money&nbsp;could&nbsp;get&nbsp;stuck&nbsp;contract&nbsp;implying&nbsp;that&nbsp;some<br/>
&nbsp;&nbsp;&nbsp;&nbsp;funded&nbsp;money&nbsp;may&nbsp;not&nbsp;be&nbsp;refundable.<br/>
&nbsp;&nbsp;&nbsp;If&nbsp;"contract_balance&nbsp;*&nbsp;exchange_rate&nbsp;&lt;=&nbsp;total_supply"&nbsp;then&nbsp;it&nbsp;should&nbsp;be<br/>
&nbsp;&nbsp;&nbsp;&nbsp;possible&nbsp;to&nbsp;withdraw&nbsp;the&nbsp;entire&nbsp;contract&nbsp;balance.<br/>
*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{can_always_fully_refund}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;finalization&nbsp;tests&nbsp;--------------------&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;finalize&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;(token_cb&nbsp;~~&gt;&nbsp;is_finalized).&nbsp;*)</span><br/>
<span class="comment">(*<br/>
Chain{|<br/>
Block&nbsp;1&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">11%256,</span> <span class="inlinecode">10)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">12%256,</span> <span class="inlinecode">7)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">13%256,</span> <span class="inlinecode">6)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">14%256,</span> <span class="inlinecode">10)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">16%256,</span> <span class="inlinecode">2)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_transfer</span></span> <span class="inlinecode">17%256,</span> <span class="inlinecode">2)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">10%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_deploy</span></span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">transfer</span></span> <span class="inlinecode">19%256</span> <span class="inlinecode">17)}</span>;<br/>
Block&nbsp;2&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">17%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">transfer</span></span> <span class="inlinecode">13%256</span> <span class="inlinecode">16)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">11%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">9,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;3&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">16%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">1,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">13%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">3,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;4&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">16%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">approve</span></span> <span class="inlinecode">17%256</span> <span class="inlinecode">2)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">14%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">8,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)}</span>;<br/>
Block&nbsp;5&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">17%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">2,</span> <span class="inlinecode"><span class="id" title="var">create_tokens</span>)};</span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">17%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">transfer_from</span></span> <span class="inlinecode">16%256</span> <span class="inlinecode">17%256</span> <span class="inlinecode">0)}</span>;<br/>
Block&nbsp;6&nbsp;<span class="inlinecode"></span>
<span class="inlinecode"><span class="id" title="var">Action</span>{<span class="id" title="var">act_from</span>:</span> <span class="inlinecode">16%256,</span> <span class="inlinecode"><span class="id" title="var">act_body</span>:</span> <span class="inlinecode">(<span class="id" title="var">act_call</span></span> <span class="inlinecode">128%256,</span> <span class="inlinecode">0,</span> <span class="inlinecode"><span class="id" title="var">finalize</span>)}</span>;&nbsp;|}<br/>
<br/>
Success&nbsp;-&nbsp;found&nbsp;witness&nbsp;satisfying&nbsp;the&nbsp;predicate!<br/>
+++&nbsp;Failed&nbsp;(as&nbsp;expected)&nbsp;after&nbsp;6&nbsp;tests&nbsp;and&nbsp;0&nbsp;shrinks.&nbsp;(0&nbsp;discards)<br/>
*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="can_always_finalize" class="idref" href="#can_always_finalize"><span class="id" title="definition">can_always_finalize</span></a> <a id="check_setup:235" class="idref" href="#check_setup:235"><span class="id" title="binder">check_setup</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="build_init_cb:237" class="idref" href="#build_init_cb:237"><span class="id" title="binder">build_init_cb</span></a> <a id="setup:236" class="idref" href="#setup:236"><span class="id" title="binder">setup</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TraceGens.html#add_block"><span class="id" title="definition">TraceGens.add_block</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#empty_chain"><span class="id" title="definition">empty_chain</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_1"><span class="id" title="definition">person_1</span></a> 10<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_2"><span class="id" title="definition">person_2</span></a> 7<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_3"><span class="id" title="definition">person_3</span></a> 6<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_transfer"><span class="id" title="definition">build_transfer</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#person_4"><span class="id" title="definition">person_4</span></a> 10<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Execution.Test.TestUtils.html#build_deploy"><span class="id" title="definition">build_deploy</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#creator"><span class="id" title="definition">creator</span></a> 0 <a class="idref" href="ConCert.Examples.BAT.BATAltFix.html#contract"><span class="id" title="definition">BATAltFix.contract</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#setup:236"><span class="id" title="variable">setup</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#gBATSetup"><span class="id" title="definition">gBATSetup</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="setup:238" class="idref" href="#setup:238"><span class="id" title="binder">setup</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#build_init_cb:237"><span class="id" title="variable">build_init_cb</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#setup:238"><span class="id" title="variable">setup</span></a>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="ConCert.Execution.ResultMonad.html#Ok"><span class="id" title="constructor">ResultMonad.Ok</span></a> <span class="id" title="var">init_cb</span> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#check_setup:235"><span class="id" title="variable">check_setup</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#setup:238"><span class="id" title="variable">setup</span></a> <span class="id" title="var">init_cb</span> <span class="id" title="notation">==&gt;</span> <span class="id" title="notation">(</span><span class="id" title="var">init_cb</span> <a class="idref" href="ConCert.Execution.Test.TestNotation.html#3df738f1514836631643bc237bca754b"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#is_finalized"><span class="id" title="definition">is_finalized</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="ConCert.Execution.ResultMonad.html#Err"><span class="id" title="constructor">ResultMonad.Err</span></a> <span class="id" title="var">_</span> =&gt; <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a> <span class="id" title="notation">==&gt;</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>).<br/>
<span class="comment">(*&nbsp;We&nbsp;would&nbsp;like&nbsp;that&nbsp;BAToken&nbsp;has&nbsp;the&nbsp;property&nbsp;that&nbsp;it&nbsp;is<br/>
&nbsp;&nbsp;&nbsp;&nbsp;always&nbsp;possible&nbsp;to&nbsp;successfully&nbsp;fund&nbsp;the&nbsp;token&nbsp;for&nbsp;any<br/>
&nbsp;&nbsp;&nbsp;&nbsp;setup&nbsp;used&nbsp;when&nbsp;deploying&nbsp;the&nbsp;token&nbsp;*)</span><br/>
<span class="comment">(*<br/>
Extract&nbsp;Constant&nbsp;defNumTests&nbsp;=&gt;&nbsp;"100".<br/>
QuickChick&nbsp;(expectFailure&nbsp;(can_always_finalize&nbsp;(fun&nbsp;_&nbsp;_&nbsp;=&gt;&nbsp;true))).<br/>
Extract&nbsp;Constant&nbsp;defNumTests&nbsp;=&gt;&nbsp;"10000".<br/>
*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="final_is_final" class="idref" href="#final_is_final"><span class="id" title="definition">final_is_final</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#token_cb"><span class="id" title="definition">token_cb</span></a> <a class="idref" href="ConCert.Execution.Test.TestNotation.html#d9e948076510bc52a4e5a2b1f6a3f08e"><span class="id" title="notation">~~~&gt;</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#bool_to_option"><span class="id" title="definition">bool_to_option</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#is_finalized"><span class="id" title="definition">is_finalized</span></a> <a class="idref" href="ConCert.Execution.Test.TestNotation.html#d9e948076510bc52a4e5a2b1f6a3f08e"><span class="id" title="notation">===&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#checkForAllStatesInTrace"><span class="id" title="definition">checkForAllStatesInTrace</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <a id="cs:239" class="idref" href="#cs:239"><span class="id" title="binder">cs</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#is_finalized"><span class="id" title="definition">is_finalized</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:239"><span class="id" title="variable">cs</span></a>).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;once&nbsp;finalized&nbsp;it&nbsp;cannot&nbsp;be&nbsp;undone&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;final_is_final.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(4648&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="can_only_finalize_once" class="idref" href="#can_only_finalize_once"><span class="id" title="definition">can_only_finalize_once</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="chain_gen:240" class="idref" href="#chain_gen:240"><span class="id" title="binder">chain_gen</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#gChain"><span class="id" title="definition">gChain</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="blocks:242" class="idref" href="#blocks:242"><span class="id" title="binder">blocks</span></a> <a id="cb:241" class="idref" href="#cb:241"><span class="id" title="binder">cb</span></a> := <a class="idref" href="ConCert.Execution.Test.TraceGens.html#trace_states_step_block"><span class="id" title="definition">trace_states_step_block</span></a> (<a class="idref" href="ConCert.Execution.Blockchain.html#builder_trace"><span class="id" title="method">builder_trace</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cb:241"><span class="id" title="variable">cb</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="is_finalize:244" class="idref" href="#is_finalize:244"><span class="id" title="binder">is_finalize</span></a> <a id="action:243" class="idref" href="#action:243"><span class="id" title="binder">action</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action:243"><span class="id" title="variable">action</span></a>.(<a class="idref" href="ConCert.Execution.Blockchain.html#act_body"><span class="id" title="projection">act_body</span></a>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="ConCert.Execution.Blockchain.html#act_call"><span class="id" title="constructor">Blockchain.act_call</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">ser_msg</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> @<a class="idref" href="ConCert.Execution.Serializable.html#deserialize"><span class="id" title="method">deserialize</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#Msg"><span class="id" title="inductive">Msg</span></a> <span class="id" title="var">_</span> <span class="id" title="var">ser_msg</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#finalize"><span class="id" title="constructor">finalize</span></a> =&gt; 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="finalize_calls':248" class="idref" href="#finalize_calls':248"><span class="id" title="binder">finalize_calls'</span></a> <a id="block:245" class="idref" href="#block:245"><span class="id" title="binder">block</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#fold_left"><span class="id" title="definition">fold_left</span></a> (<span class="id" title="keyword">fun</span> <a id="count:246" class="idref" href="#count:246"><span class="id" title="binder">count</span></a> <a id="action:247" class="idref" href="#action:247"><span class="id" title="binder">action</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#count:246"><span class="id" title="variable">count</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#is_finalize:244"><span class="id" title="variable">is_finalize</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#action:247"><span class="id" title="variable">action</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="ConCert.Execution.Blockchain.html#chain_state_queue"><span class="id" title="projection">chain_state_queue</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#block:245"><span class="id" title="variable">block</span></a>) 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="finalize_calls:252" class="idref" href="#finalize_calls:252"><span class="id" title="binder">finalize_calls</span></a> <a id="blocks:249" class="idref" href="#blocks:249"><span class="id" title="binder">blocks</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#fold_left"><span class="id" title="definition">fold_left</span></a> (<span class="id" title="keyword">fun</span> <a id="count:250" class="idref" href="#count:250"><span class="id" title="binder">count</span></a> <a id="block:251" class="idref" href="#block:251"><span class="id" title="binder">block</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#count:250"><span class="id" title="variable">count</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#finalize_calls':248"><span class="id" title="variable">finalize_calls'</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#block:251"><span class="id" title="variable">block</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#blocks:249"><span class="id" title="variable">blocks</span></a> 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">forAll</span> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#chain_gen:240"><span class="id" title="variable">chain_gen</span></a> (<span class="id" title="keyword">fun</span> <a id="cb:253" class="idref" href="#cb:253"><span class="id" title="binder">cb</span></a> =&gt; <span class="id" title="method">checker</span> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#finalize_calls:252"><span class="id" title="variable">finalize_calls</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#blocks:242"><span class="id" title="variable">blocks</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cb:253"><span class="id" title="variable">cb</span></a>) <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">&lt;=?</span></a> 1)).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;possible&nbsp;to&nbsp;finalize&nbsp;more&nbsp;than&nbsp;once&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;can_only_finalize_once.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="final_implies_total_supply_in_range" class="idref" href="#final_implies_total_supply_in_range"><span class="id" title="definition">final_implies_total_supply_in_range</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="total_supply_in_range:255" class="idref" href="#total_supply_in_range:255"><span class="id" title="binder">total_supply_in_range</span></a> <a id="cs:254" class="idref" href="#cs:254"><span class="id" title="binder">cs</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:254"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">state</span> =&gt; <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#tokenMin_"><span class="id" title="definition">tokenMin_</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#initSupply"><span class="id" title="projection">initSupply</span></a> <span class="id" title="var">state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#tokenCap_"><span class="id" title="definition">tokenCap_</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">+</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#initSupply"><span class="id" title="projection">initSupply</span></a> <span class="id" title="var">state</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#64708cc1fcff61c206ed571fe7828ea8"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> =&gt; <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#token_cb"><span class="id" title="definition">token_cb</span></a> <a class="idref" href="ConCert.Execution.Test.TestNotation.html#d9e948076510bc52a4e5a2b1f6a3f08e"><span class="id" title="notation">~~~&gt;</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#bool_to_option"><span class="id" title="definition">bool_to_option</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#is_finalized"><span class="id" title="definition">is_finalized</span></a> <a class="idref" href="ConCert.Execution.Test.TestNotation.html#d9e948076510bc52a4e5a2b1f6a3f08e"><span class="id" title="notation">===&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#checkForAllStatesInTrace"><span class="id" title="definition">checkForAllStatesInTrace</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <a id="cs:256" class="idref" href="#cs:256"><span class="id" title="binder">cs</span></a> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#total_supply_in_range:255"><span class="id" title="variable">total_supply_in_range</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:256"><span class="id" title="variable">cs</span></a>).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;once&nbsp;finalized&nbsp;then&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;is:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;1)&nbsp;at&nbsp;least&nbsp;_tokenMin<br/>
&nbsp;&nbsp;&nbsp;&nbsp;2)&nbsp;no&nbsp;bigger&nbsp;than&nbsp;_tokenCap&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;final_implies_total_supply_in_range.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(4589&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="final_implies_total_supply_constant" class="idref" href="#final_implies_total_supply_constant"><span class="id" title="definition">final_implies_total_supply_constant</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="get_satisfying_state:258" class="idref" href="#get_satisfying_state:258"><span class="id" title="binder">get_satisfying_state</span></a> <a id="trace:257" class="idref" href="#trace:257"><span class="id" title="binder">trace</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#last"><span class="id" title="definition">last</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#trace:257"><span class="id" title="variable">trace</span></a> <a class="idref" href="ConCert.Execution.Blockchain.html#empty_state"><span class="id" title="definition">empty_state</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="get_total_supply:260" class="idref" href="#get_total_supply:260"><span class="id" title="binder">get_total_supply</span></a> <a id="cs:259" class="idref" href="#cs:259"><span class="id" title="binder">cs</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:259"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">state</span> =&gt; <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">state</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="finalized_total_supply:262" class="idref" href="#finalized_total_supply:262"><span class="id" title="binder">finalized_total_supply</span></a> <a id="trace:261" class="idref" href="#trace:261"><span class="id" title="binder">trace</span></a> := <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#get_total_supply:260"><span class="id" title="variable">get_total_supply</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#get_satisfying_state:258"><span class="id" title="variable">get_satisfying_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#trace:261"><span class="id" title="variable">trace</span></a>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#token_cb"><span class="id" title="definition">token_cb</span></a> <a class="idref" href="ConCert.Execution.Test.TestNotation.html#d9e948076510bc52a4e5a2b1f6a3f08e"><span class="id" title="notation">~~~&gt;</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#bool_to_option"><span class="id" title="definition">bool_to_option</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#is_finalized"><span class="id" title="definition">is_finalized</span></a> <a class="idref" href="ConCert.Execution.Test.TestNotation.html#d9e948076510bc52a4e5a2b1f6a3f08e"><span class="id" title="notation">===&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#checkForAllStatesInTrace"><span class="id" title="definition">checkForAllStatesInTrace</span></a> (<span class="id" title="keyword">fun</span> <a id="pre_trace:263" class="idref" href="#pre_trace:263"><span class="id" title="binder">pre_trace</span></a> <a id="cs:264" class="idref" href="#cs:264"><span class="id" title="binder">cs</span></a> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#get_total_supply:260"><span class="id" title="variable">get_total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:264"><span class="id" title="variable">cs</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#finalized_total_supply:262"><span class="id" title="variable">finalized_total_supply</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#pre_trace:263"><span class="id" title="variable">pre_trace</span></a>).<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;once&nbsp;finalized&nbsp;then&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;does&nbsp;not&nbsp;change&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;final_implies_total_supply_constant.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(4717&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="final_implies_contract_balance_is_zero" class="idref" href="#final_implies_contract_balance_is_zero"><span class="id" title="definition">final_implies_contract_balance_is_zero</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="contract_balance_empty:267" class="idref" href="#contract_balance_empty:267"><span class="id" title="binder">contract_balance_empty</span></a> <a id="trace:265" class="idref" href="#trace:265"><span class="id" title="binder">trace</span></a> <a id="cs:266" class="idref" href="#cs:266"><span class="id" title="binder">cs</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.ZArith.BinInt.html#Z.eqb"><span class="id" title="definition">Z.eqb</span></a> (<a class="idref" href="ConCert.Execution.Blockchain.html#env_account_balances"><span class="id" title="projection">env_account_balances</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:266"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a>) 0 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#token_cb"><span class="id" title="definition">token_cb</span></a> <a class="idref" href="ConCert.Execution.Test.TestNotation.html#d9e948076510bc52a4e5a2b1f6a3f08e"><span class="id" title="notation">~~~&gt;</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#bool_to_option"><span class="id" title="definition">bool_to_option</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#is_finalized"><span class="id" title="definition">is_finalized</span></a> <a class="idref" href="ConCert.Execution.Test.TestNotation.html#d9e948076510bc52a4e5a2b1f6a3f08e"><span class="id" title="notation">===&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#checkForAllStatesInTrace"><span class="id" title="definition">checkForAllStatesInTrace</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#contract_balance_empty:267"><span class="id" title="variable">contract_balance_empty</span></a>.<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;once&nbsp;finalized&nbsp;then&nbsp;the&nbsp;contract&nbsp;balance&nbsp;is&nbsp;0&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;final_implies_contract_balance_is_zero.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(4675&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;--------------------&nbsp;total_supply&nbsp;tests&nbsp;--------------------&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="total_supply_bounds" class="idref" href="#total_supply_bounds"><span class="id" title="definition">total_supply_bounds</span></a> (<a id="cs:268" class="idref" href="#cs:268"><span class="id" title="binder">cs</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ChainState"><span class="id" title="record">ChainState</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:268"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">cstate</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="method">checker</span> (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">(</span></a>0 <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">cstate</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">&amp;&amp;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">cstate</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#05335162eaa480b4616c18e1c329eb57"><span class="id" title="notation">&lt;=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#tokenCap_"><span class="id" title="definition">tokenCap_</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#::bool_scope:x_'&amp;&amp;'_x"><span class="id" title="notation">)</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;when&nbsp;the&nbsp;contract&nbsp;is&nbsp;not&nbsp;finalized<br/>
&nbsp;&nbsp;&nbsp;then&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;is&nbsp;always<br/>
&nbsp;&nbsp;&nbsp;&nbsp;1)&nbsp;larger&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;2)&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;the&nbsp;funding&nbsp;cap<br/>
*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{total_supply_bounds}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="total_supply_eq_sum_balances" class="idref" href="#total_supply_eq_sum_balances"><span class="id" title="definition">total_supply_eq_sum_balances</span></a> (<a id="cs:269" class="idref" href="#cs:269"><span class="id" title="binder">cs</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ChainState"><span class="id" title="record">ChainState</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:269"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="balances_list:270" class="idref" href="#balances_list:270"><span class="id" title="binder">balances_list</span></a> := <a class="idref" href="ConCert.Execution.Test.TestUtils.html#:::x_'o'_x"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#map"><span class="id" title="definition">map</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#snd"><span class="id" title="definition">snd</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#:::x_'o'_x"><span class="id" title="notation">o</span></a> <a class="idref" href="ConCert.Execution.Containers.html#FMap.elements"><span class="id" title="abbreviation">FMap.elements</span></a><a class="idref" href="ConCert.Execution.Test.TestUtils.html#:::x_'o'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#:::x_'o'_x"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Execution.Test.TestUtils.html#:::x_'o'_x"><span class="id" title="notation">balances</span></a> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#:::x_'o'_x"><span class="id" title="notation">cstate</span></a><a class="idref" href="ConCert.Execution.Test.TestUtils.html#:::x_'o'_x"><span class="id" title="notation">)</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="balances_sum:271" class="idref" href="#balances_sum:271"><span class="id" title="binder">balances_sum</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Numbers.BinNums.html#N"><span class="id" title="inductive">N</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Lists.List.html#fold_left"><span class="id" title="definition">fold_left</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.add"><span class="id" title="definition">N.add</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#balances_list:270"><span class="id" title="variable">balances_list</span></a> 0%<span class="id" title="var">N</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">checker</span> (<a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">cstate</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#balances_sum:271"><span class="id" title="variable">balances_sum</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;Check&nbsp;that&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;is&nbsp;always&nbsp;equal<br/>
&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;the&nbsp;sum&nbsp;of&nbsp;all&nbsp;token&nbsp;balances&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{total_supply_eq_sum_balances}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Definition</span> <a id="paid_tokens_modulo_exchange_rate" class="idref" href="#paid_tokens_modulo_exchange_rate"><span class="id" title="definition">paid_tokens_modulo_exchange_rate</span></a> (<a id="cs:272" class="idref" href="#cs:272"><span class="id" title="binder">cs</span></a> : <a class="idref" href="ConCert.Execution.Blockchain.html#ChainState"><span class="id" title="record">ChainState</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="ConCert.Execution.Test.TestUtils.html#get_contract_state"><span class="id" title="definition">get_contract_state</span></a> <a class="idref" href="ConCert.Examples.BAT.BATCommon.html#State"><span class="id" title="record">State</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#cs:272"><span class="id" title="variable">cs</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#contract_base_addr"><span class="id" title="definition">contract_base_addr</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">cstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="paid_tokens:273" class="idref" href="#paid_tokens:273"><span class="id" title="binder">paid_tokens</span></a> := <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">cstate</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">-</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">(</span></a><a class="idref" href="ConCert.Examples.BAT.BATCommon.html#initSupply"><span class="id" title="projection">initSupply</span></a> <span class="id" title="var">cstate</span><a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#::N_scope:x_'-'_x"><span class="id" title="notation">)</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">cstate</span>.(<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#isFinalized"><span class="id" title="projection">isFinalized</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="method">checker</span> (0 <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.modulo"><span class="id" title="definition">N.modulo</span></a> <a class="idref" href="ConCert.Examples.BAT.BATAltFixTests.html#paid_tokens:273"><span class="id" title="variable">paid_tokens</span></a> <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#exchangeRate_"><span class="id" title="definition">exchangeRate_</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="method">checker</span> (0 <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#59a5ff4a6cbb127625aba1a377a243d1"><span class="id" title="notation">=?</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.NArith.BinNat.html#N.modulo"><span class="id" title="definition">N.modulo</span></a> (<a class="idref" href="ConCert.Examples.BAT.BATCommon.html#total_supply"><span class="id" title="definition">total_supply</span></a> <span class="id" title="var">cstate</span>) <a class="idref" href="ConCert.Examples.BAT.BATTestCommon.html#exchangeRate_"><span class="id" title="definition">exchangeRate_</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> =&gt; <span class="id" title="method">checker</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.16.1/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="comment">(*&nbsp;We&nbsp;check&nbsp;that&nbsp;the&nbsp;total&nbsp;supply&nbsp;of&nbsp;tokens&nbsp;minus&nbsp;the&nbsp;inital&nbsp;supply<br/>
&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;a&nbsp;multiple&nbsp;of&nbsp;exchange&nbsp;rate.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;QuickChick&nbsp;({{paid_tokens_modulo_exchange_rate}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
</div>
</div>
<div id="footer">
  Generated by <a href="https://coq.inria.fr/">coqdoc</a> and improved with <a href="https://github.com/tebbi/coqdocjs">CoqdocJS</a> and <a href="https://github.com/jgallen23/toc">TOC</a>
</div>
</div>
<script>
  const elements = document.getElementsByClassName("libtitle");
  while(elements.length > 0){
        elements[0].parentNode.removeChild(elements[0]);
  }
  if (window.location.pathname.endsWith("/toc.html")) {
      const jstocDiv = document.getElementById("js-toc");
      jstocDiv.classList.remove("toc");
      jstocDiv.classList.add("jstoc-hidden");
      const jstocHeaderDiv = document.getElementById("js-toc-header");
      jstocHeaderDiv.classList.add("jstoc-hidden");
      const mainDiv = document.getElementById("main");
      mainDiv.classList.add("jstoc-hidden-main");
      const toggleDiv = document.getElementById("toggle-toc");
      toggleDiv.classList.add("jstoc-hidden");
  }
  console.log(window.location.pathname);
</script>
<script type="text/javascript" src="toc.js"></script>
</body>

</html>
